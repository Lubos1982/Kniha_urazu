<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FormulÃ¡Å™ â€“ PracovnÃ­ Ãºraz (Aâ€“D)</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --text:#111827;
    --accent:#2563eb; --accent-2:#0ea5e9; --border:#e5e7eb; --field:#ffffff;
    --danger:#ef4444; --danger-bg:#fee2e2; --danger-border:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

  header{
    position:sticky;top:0;z-index:5;padding:16px 18px;border-bottom:1px solid var(--border);
    background:linear-gradient(90deg,#ffffffd9,#f8fafcd9);
    backdrop-filter:saturate(1.1) blur(4px)
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:0 0 4px;font-size:28px}
  .subtitle{color:var(--muted);font-size:14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;align-items:flex-start}
  button{
    appearance:none;border:1px solid transparent;border-radius:10px;padding:10px 14px;color:#fff;cursor:pointer;font-weight:700;
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 6px 14px rgba(37,99,235,.22);
    transition:transform .06s ease,box-shadow .2s ease
  }
  button.word{background:linear-gradient(135deg,#4f46e5,#06b6d4); box-shadow:0 6px 16px rgba(79,70,229,.28)}
  button.ghost{background:#f8fafc;color:#111827;border:1px solid var(--border)}
  button:hover{transform:translateY(-1px)}
  .hint{font-size:12.5px;color:#4b5563;margin-top:6px;max-width:380px}

  .grid{display:grid;gap:16px;grid-template-columns:repeat(12,minmax(0,1fr))}
  .card{grid-column:1/-1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 14px}
  .card h2{margin:0 0 10px;font-size:18px;font-weight:800;display:flex;align-items:center;gap:10px}
  .badge{display:inline-grid;place-items:center;min-width:32px;min-height:32px;border-radius:8px;font-weight:900;background:#eef2ff;border:1px solid #e5e7eb;color:#1f2937}
  .row{display:grid;gap:10px;grid-template-columns:repeat(12,minmax(0,1fr))}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}

  label{display:block;margin-bottom:6px;color:#111827;font-weight:800;font-size:15px}
  .field{position:relative}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1;background:var(--field);color:var(--text);outline:none}
  textarea{min-height:110px;resize:vertical}
  .muted{color:var(--muted);font-size:13px}
  .req:after{content:" *";color:#dc2626}
  .help{margin-top:6px;font-size:12.5px;color:#4b5563}

  .lock{background:#f8fafc;border-color:#e5e7eb;color:#111827}
  .lock[readonly]{cursor:not-allowed}
  .picker-btn{position:absolute;right:8px;top:8px;border-radius:8px;border:1px solid #cbd5e1;background:#f9fafb;color:#111827;padding:6px 8px;cursor:pointer}
  .picker-btn:hover{filter:brightness(1.05)}

  .brand{display:flex;align-items:center;gap:14px;margin:6px 0 12px 0}
  .brand img{height:56px;display:block}

  .error{border-color:var(--danger-border)!important;background:var(--danger-bg)!important}
  .error-msg{margin-top:6px;color:#991b1b;font-size:12px}
  .hidden{display:none}

  /* Banner validace */
  #val-banner{
    display:none; margin:10px 0 0 0; padding:10px 12px;
    background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:8px; font-weight:700;
  }

  /* Tisk */
  .print-only{display:none}
  @media print{
    header,.toolbar,.picker-btn,.error-msg,#val-banner{display:none !important}
    .card{box-shadow:none;border-color:#ddd;background:white;color:#111}
    body{background:white;color:#111}
    input,select,textarea{background:white;color:#111;border-color:#bbb}
    .badge{background:#f3f4f6;border-color:#e5e7eb;color:#111}
    #c-zdroj,#c-priciny{display:none !important}
    #m-zdroj,#m-priciny{display:block !important}
    .help{display:none !important}
    a[href]:after{content:"" !important}
    .print-hide{display:none !important}
    .btn-del-svedek,.btn-add-svedek{display:none !important}
    #btn-settings,#dlg-settings{display:none !important}
  }

  @media (max-width:900px){.col-6,.col-4,.col-3{grid-column:span 12}}

  /* âš™ï¸ NastavenÃ­ â€“ pÅ™esnÃ© vystÅ™edÄ›nÃ­ ikony */
  #btn-settings{
    position:fixed;top:12px;right:12px;z-index:20;
    border:1px solid var(--border); background:#ffffffcc;color:#111827;
    border-radius:50%; width:38px;height:38px;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    padding:0; line-height:1; font-size:18px;
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>FormulÃ¡Å™ â€“ zÃ¡znam o pracovnÃ­m Ãºrazu</h1>
    <div class="subtitle">Sekce Aâ€“D â€¢ tisk â€¢ export do Wordu (.doc) â€¢ odeslÃ¡nÃ­ eâ€‘mailem</div>

    <div class="toolbar">
      <button type="button" onclick="onPrint()">ğŸ–¨ï¸ Vytisknout</button>

      <!-- RozdÄ›lenÃ© akce -->
      <div style="display:flex;flex-direction:column">
        <button type="button" class="word" onclick="onSaveDocWord()">ğŸ“ UloÅ¾it do Wordu (.doc)</button>
      </div>

      <div style="display:flex;flex-direction:column">
        <button type="button" class="word" onclick="onSendMail()">ğŸ“§ Odeslat eâ€‘mailem</button>
        <div class="hint">
          Funguje jen v prohlÃ­Å¾eÄÃ­ch s <strong>Web Share API</strong> pro soubory
          (napÅ™. <strong>Edge</strong>, <strong>Chrome</strong> na <strong>Windows 10/11</strong>) a pokud je
          <strong>Outlook</strong> dostupnÃ½ jako cÃ­l â€SdÃ­letâ€œ. <em>Firefox</em> nepodporuje.
          (Web Share vyÅ¾aduje <strong>HTTPS</strong>.)
        </div>
      </div>

      <button type="button" class="ghost" onclick="onClear()">â™»ï¸ Vymazat</button>
    </div>

    <!-- Banner validace -->
    <div id="val-banner" role="alert">DoplÅˆte prosÃ­m zvÃ½raznÄ›nÃ¡ povinnÃ¡ pole a zkuste to znovu.</div>
  </div>
</header>

<!-- âš™ï¸ NastavenÃ­ pÅ™Ã­jemcÅ¯ + OWA-only (heslo 1991) -->
<button type="button" id="btn-settings" title="NastavenÃ­" onclick="openSettings()"><span aria-hidden="true">âš™ï¸</span></button>

<dialog id="dlg-settings" style="border:1px solid #e5e7eb;border-radius:12px;max-width:520px;padding:16px">
  <form method="dialog" onsubmit="return false" style="display:flex;flex-direction:column;gap:10px">
    <h3 style="margin:0 0 6px">NastavenÃ­ eâ€‘mailu</h3>

    <label style="font-weight:700">PÅ™Ã­jemci (Komu)</label>
    <p class="muted" style="margin:0 0 8px">Spravujte seznam pÅ™Ã­jemcÅ¯. Lze pÅ™idat vÃ­ce eâ€‘mailÅ¯.</p>
    <div id="recipients-list" style="display:flex;flex-wrap:wrap;gap:6px"></div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
      <input id="inp-email-add" type="email" placeholder="novy.prijemce@firma.cz"
             style="flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:10px" />
      <button type="button" class="ghost" onclick="addRecipientFromInput()">PÅ™idat</button>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:6px 0">

    <label style="display:flex;gap:10px;align-items:center">
      <input id="inp-owa-only" type="checkbox">
      <span><strong>VÅ¾dy pouÅ¾Ã­t OWA (pÅ™eskoÄit SdÃ­let)</strong><br>
        <span class="muted">StÃ¡hne .doc a otevÅ™e Outlook na webu s vyplnÄ›nÃ½mi poli. PÅ™Ã­lohu pÅ™etÃ¡hnete do okna zprÃ¡vy.</span>
      </span>
    </label>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button type="button" class="ghost" onclick="document.getElementById('dlg-settings').close()">ZruÅ¡it</button>
      <button type="button" class="word" onclick="saveSettings()">UloÅ¾it</button>
    </div>
  </form>
</dialog>

<main class="wrap" id="print-root">
  <!-- Logo -->
  <div class="brand"><img id="brand-logo" alt="LE &amp; CO logo"></div>

  <!-- ====== FORMULÃÅ˜ Aâ€“D ====== -->
  <form id="form-uraz" class="grid" onsubmit="return false" novalidate>
    <!-- A -->
    <section class="card">
      <h2><span class="badge">A</span> Ãšdaje o zamÄ›stnavateli</h2>
      <div class="row">
        <div class="col-6 field">
          <label class="req" for="a-zam">NÃ¡zev zamÄ›stnavatele</label>
          <input id="a-zam" value="LE &amp; CO â€“ Ing. JiÅ™Ã­ Lenc, s.r.o." readonly class="lock" title="UzamÄeno â€“ nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="a-ico">IÄŒO</label>
          <input id="a-ico" value="26502658" readonly class="lock" title="UzamÄeno â€“ nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-12 col-6 field">
          <label class="req" for="a-sidlo">SÃ­dlo (adresa)</label>
          <input id="a-sidlo" value="PodÄ›bradskÃ¡ 606, Jirny" readonly class="lock" title="UzamÄeno â€“ nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
      </div>

      <details id="opt-employer" style="margin-top:10px">
        <summary><strong>JinÃ½ zamÄ›stnavatel (pokud se jednÃ¡ o zamÄ›stnance jinÃ©ho zamÄ›stnavatele)</strong></summary>
        <div class="row" style="margin-top:10px">
          <div class="col-6 field">
            <label class="req" for="a-zam2">NÃ¡zev zamÄ›stnavatele</label>
            <input id="a-zam2" placeholder="NÃ¡zev jinÃ©ho zamÄ›stnavatele">
            <div class="error-msg hidden"></div>
          </div>
          <div class="col-3 field">
            <label class="req" for="a-ico2">IÄŒO</label>
            <input id="a-ico2" placeholder="IÄŒO">
            <div class="error-msg hidden"></div>
          </div>
          <div class="col-12 col-6 field">
            <label class="req" for="a-sidlo2">SÃ­dlo (adresa)</label>
            <input id="a-sidlo2" placeholder="Adresa">
            <div class="error-msg hidden"></div>
          </div>
        </div>
      </details>
    </section>

    <!-- B -->
    <section class="card">
      <h2><span class="badge">B</span> Ãšdaje o postiÅ¾enÃ©m</h2>
      <div class="row">
        <div class="col-6 field">
          <label class="req" for="b-jmeno">JmÃ©no a pÅ™Ã­jmenÃ­</label>
          <input id="b-jmeno" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="b-datum">Datum narozenÃ­</label>
          <input id="b-datum" type="date" required>
          <button class="picker-btn" type="button" onclick="openPicker('b-datum')" title="OtevÅ™Ã­t kalendÃ¡Å™">ğŸ“…</button>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="b-prace">Druh prÃ¡ce</label>
          <input id="b-prace" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="b-status">PostiÅ¾enÃ½ je</label>
          <select id="b-status" required>
            <option value="" disabled selected>â€” vyberte â€”</option>
            <option>zamÄ›stnanec v pracovnÃ­m pomÄ›ru</option>
            <option>zamÄ›stnanec zamÄ›stnanÃ½ na zÃ¡kladÄ› dohod o pracÃ­ch konanÃ½ch mimo pracovnÃ­ pomÄ›r</option>
            <option>zamÄ›stnanec jinÃ©ho zamÄ›stnavatele</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>
      </div>
    </section>

    <!-- C -->
    <section class="card">
      <h2><span class="badge">C</span> Ãšdaje o Ãºrazu</h2>
      <div class="row">
        <div class="col-3 field">
          <label class="req" for="c-datum">Datum a hodina Ãºrazu</label>
          <input id="c-datum" type="datetime-local" required>
          <button class="picker-btn" type="button" onclick="openPicker('c-datum')" title="OtevÅ™Ã­t kalendÃ¡Å™">ğŸ“…</button>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-hodiny">PoÄet hodin odpracovanÃ½ch pÅ™ed Ãºrazem</label>
          <input id="c-hodiny" type="number" min="0" step="0.5" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-pocet">PoÄet zranÄ›nÃ½ch osob celkem</label>
          <input id="c-pocet" type="number" min="1" value="1" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-druh-urazu">Druh Ãºrazu</label>
          <select id="c-druh-urazu" required>
            <option value="" disabled selected>â€” vyberte â€”</option>
            <option>smrtelnÃ½</option>
            <option>ostatnÃ­</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-druh-zraneni">ÄŒÃ­selnÃ½ kÃ³d a druh zranÄ›nÃ­ (ESAW)</label>
          <select id="c-druh-zraneni" required></select>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="c-cast-tela">ÄŒÃ­selnÃ½ kÃ³d a zranÄ›nÃ¡ ÄÃ¡st tÄ›la (ESAW)</label>
          <select id="c-cast-tela" required></select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-cinnost">ÄŒinnost, pÅ™i kterÃ© k Ãºrazu doÅ¡lo</label>
          <input id="c-cinnost" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="c-misto">MÃ­sto, kde k Ãºrazu doÅ¡lo</label>
          <input id="c-misto" required>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-3 field">
          <label class="req" for="c-pracoviste">Bylo mÃ­sto Ãºrazu pravidelnÃ½m pracoviÅ¡tÄ›m?</label>
          <select id="c-pracoviste" required>
            <option value="" disabled selected>â€” vyberte â€”</option>
            <option>ANO</option>
            <option>NE</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-zdroj">Co bylo zdrojem Ãºrazu? (mÅ¯Å¾ete vybrat vÃ­ce)</label>
          <select id="c-zdroj" multiple size="8">
            <option>dopravnÃ­ prostÅ™edek</option>
            <option>stroje a zaÅ™Ã­zenÃ­ pÅ™enosnÃ¡ nebo mobilnÃ­</option>
            <option>materiÃ¡l, bÅ™emena, pÅ™edmÄ›ty (pÃ¡d, pÅ™iraÅ¾enÃ­, odlÃ©tnutÃ­, nÃ¡raz, zavalenÃ­)</option>
            <option>pÃ¡d na rovinÄ›, z vÃ½Å¡ky, do hloubky, propadnutÃ­</option>
            <option>nÃ¡stroj, pÅ™Ã­stroj, nÃ¡Å™adÃ­</option>
            <option>prÅ¯myslovÃ© Å¡kodliviny, chemickÃ© lÃ¡tky, biologickÃ© Äinitele</option>
            <option>horkÃ© lÃ¡tky a pÅ™edmÄ›ty, oheÅˆ a vÃ½buÅ¡niny</option>
            <option>stroje a stabilnÃ­ zaÅ™Ã­zenÃ­</option>
            <option>lidÃ©, zvÃ­Å™ata nebo pÅ™Ã­rodnÃ­ Å¾ivly</option>
            <option>elektrickÃ¡ energie</option>
            <option>jinÃ½ blÃ­Å¾e nespecifikovanÃ½ zdroj</option>
          </select>
          <div class="help">Pro vÃ­ce poloÅ¾ek drÅ¾te <strong>Ctrl</strong> a klikejte myÅ¡Ã­. Pro souvislÃ½ vÃ½bÄ›r pouÅ¾ijte <strong>Shift</strong>.</div>
          <div class="error-msg hidden"></div>
          <div id="m-zdroj" class="print-only muted"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-priciny">ProÄ k Ãºrazu doÅ¡lo? (pÅ™Ã­Äiny; vÃ½bÄ›r vÃ­ce moÅ¾nostÃ­)</label>
          <select id="c-priciny" multiple size="8">
            <option>pro poruchu nebo vadnÃ½ stav nÄ›kterÃ©ho ze zdrojÅ¯ Ãºrazu</option>
            <option>pro Å¡patnÃ© nebo nedostateÄnÃ© vyhodnocenÃ­ rizika</option>
            <option>zÃ¡vady na pracoviÅ¡ti</option>
            <option>pro nedostateÄnÃ© osobnÃ­ zajiÅ¡tÄ›nÃ­ zamÄ›stnance vÄetnÄ› OOPP</option>
            <option>pro poruÅ¡enÃ­ pÅ™edpisÅ¯ vztahujÃ­cÃ­ch se k prÃ¡ci nebo pokynÅ¯ zamÄ›stnavatele</option>
            <option>pro nepÅ™edvÃ­datelnÃ© riziko prÃ¡ce nebo selhÃ¡nÃ­ lidskÃ©ho Äinitele</option>
            <option>pro jinÃ½, blÃ­Å¾e nespecifikovatelnÃ½ dÅ¯vod</option>
          </select>
          <div class="help">Pro vÃ­ce poloÅ¾ek drÅ¾te <strong>Ctrl</strong> a klikejte myÅ¡Ã­. Pro souvislÃ½ vÃ½bÄ›r pouÅ¾ijte <strong>Shift</strong>.</div>
          <div class="error-msg hidden"></div>
          <div id="m-priciny" class="print-only muted"></div>
        </div>

        <div class="col-12 field">
          <label class="req" for="c-popis">Popis ÃºrazovÃ©ho dÄ›je</label>
          <textarea id="c-popis" required placeholder="StruÄnÄ› a vÄ›cnÄ› popiÅ¡te prÅ¯bÄ›h udÃ¡lostiâ€¦"></textarea>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-3 field">
          <label class="req" for="c-dech">Byla provedena dechovÃ¡ zkouÅ¡ka na alkohol?</label>
          <select id="c-dech" required>
            <option value="" disabled selected>â€” vyberte â€”</option>
            <option>ANO</option>
            <option>NE</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>
      </div>
    </section>

    <!-- D -->
    <section class="card">
      <h2><span class="badge">D</span> PotvrzujÃ­cÃ­ Ãºdaje</h2>
      <p class="muted" style="font-size:16px;line-height:1.6">
        PostiÅ¾enÃ½ svÃ½m podpisem stvrzuje, Å¾e byl pÅ™ed vyÅ¡etÅ™ovÃ¡nÃ­m pÅ™Ã­Äin a okolnostÃ­ vzniku pracovnÃ­ho Ãºrazu zamÄ›stnavatelem pouÄen
        o jeho povinnosti vypovÃ­dat pravdivÄ› a nic nezamlÄet a o prÃ¡vnÃ­ch nÃ¡sledcÃ­ch nepravdivÃ© nebo neÃºplnÃ© vÃ½povÄ›di a rovnÄ›Å¾ ÄestnÄ›
        prohlaÅ¡uje, Å¾e jeho vÃ½povÄ›Ä byla ÃºplnÃ¡ a pravdivÃ¡.
      </p>
      <div class="row">
        <div class="col-3 field">
          <label for="d-datum-podpis">Datum a podpis postiÅ¾enÃ©ho (podle moÅ¾nostÃ­)</label>
          <input id="d-datum-podpis" type="date">
          <button class="picker-btn" type="button" onclick="openPicker('d-datum-podpis')" title="OtevÅ™Ã­t kalendÃ¡Å™">ğŸ“…</button>
        </div>

        <div class="col-12">
          <p class="muted" style="font-size:16px;line-height:1.6"><strong>SvÄ›dci ÄestnÄ› prohlaÅ¡ujÃ­</strong> a svÃ½m nÃ­Å¾e uvedenÃ½m podpisem stvrzujÃ­, Å¾e jejich vÃ½povÄ›Ä byla ÃºplnÃ¡ a pravdivÃ¡.</p>
          <div id="svedci-list" class="list"></div>
          <div style="margin-top:8px">
            <button type="button" class="ghost btn-add-svedek" onclick="addSvedek()">â• PÅ™idat svÄ›dka</button>
          </div>
        </div>

        <div class="col-12 field">
          <label for="d-zapis">ZapisujÃ­cÃ­ zamÄ›stnanec (datum, jmÃ©no a pÅ™Ã­jmenÃ­, pracovnÃ­ zaÅ™azenÃ­ a podpis)</label>
          <textarea id="d-zapis" placeholder="NapÅ™.: 2025-10-02 â€“ LuboÅ¡ JaroÅ¡, sprÃ¡vce centra informacÃ­, podpisâ€¦"></textarea>
        </div>
      </div>
    </section>
  </form>
</main>

<script>
"use strict";

/* ===== KONFIG ===== */
const STORAGE_FORM          = 'formular_uraz_v1';
const STORAGE_RECIPIENTS    = 'formular_uraz_email_to_list';
const STORAGE_OWA_ONLY      = 'formular_uraz_use_owa_only';
const LOGO_SRC              = "LECO_nove.jpg";
let   DEF_A = { zam:"", ico:"", sidlo:"" };

/* ===== PomocnÃ© ===== */
function openPicker(id){
  const el = document.getElementById(id);
  if(!el) return;
  if(typeof el.showPicker === "function"){ try{ el.showPicker(); return; }catch(e){} }
  el.focus(); try{ el.click(); }catch(_){}
}
function isEmpty(v){ return !v || !String(v).trim(); }
function todayLocalISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function safeFileName(s){return (s||'bez-jmena').replace(/[\\/:*?"<>|]+/g,'').trim().replace(/\s+/g,'_');}

/* ===== Banner validace ===== */
function showValidationBanner(firstErrorEl){
  const banner = document.getElementById('val-banner');
  if (banner) banner.style.display = 'block';
  if (firstErrorEl && typeof firstErrorEl.scrollIntoView === 'function') {
    firstErrorEl.scrollIntoView({behavior:'smooth', block:'center'});
    try { firstErrorEl.focus({preventScroll:true}); } catch(_){}
  }
}

/* ===== ESAW data ===== */
const ESAW_INJURY=[{code:"000",label:"NeznÃ¡mÃ½ nebo neurÄenÃ½ druh zranÄ›nÃ­"},{code:"010",label:"RÃ¡ny a povrchovÃ¡ zranÄ›nÃ­"},{code:"011",label:"PovrchovÃ© zranÄ›nÃ­"},{code:"012",label:"OtevÅ™enÃ© rÃ¡ny"},{code:"019",label:"JinÃ© typy ran a povrchovÃ½ch zranÄ›nÃ­"},{code:"020",label:"Zlomeniny kostÃ­"},{code:"021",label:"ZavÅ™enÃ© zlomeniny"},{code:"022",label:"OtevÅ™enÃ© zlomeniny"},{code:"029",label:"JinÃ© typy zlomenin kostÃ­"},{code:"030",label:"VykloubenÃ­, vyvrtnutÃ­, nataÅ¾enÃ­"},{code:"031",label:"VykloubenÃ­ nebo neÃºplnÃ© vykloubenÃ­"},{code:"032",label:"VyvrtnutÃ­ nebo nataÅ¾enÃ­"},{code:"039",label:"JinÃ© typy vykloubenÃ­, vyvrtnutÃ­, nataÅ¾enÃ­"},{code:"040",label:"TraumatickÃ¡ amputace (ztrÃ¡ta ÄÃ¡sti tÄ›la)"},{code:"050",label:"OtÅ™es mozku a vnitÅ™nÃ­ zranÄ›nÃ­"},{code:"051",label:"OtÅ™es mozku a vnitrolebeÄnÃ­ zranÄ›nÃ­"},{code:"052",label:"VnitÅ™nÃ­ zranÄ›nÃ­"},{code:"059",label:"JinÃ© typy otÅ™esÅ¯ mozku a vnitÅ™nÃ­ch zranÄ›nÃ­"},{code:"060",label:"PopÃ¡leniny, opaÅ™eniny a omrzliny"},{code:"061",label:"PopÃ¡leniny a opaÅ™eniny (tepelnÃ©)"},{code:"062",label:"ChemickÃ© popÃ¡leniny (poleptÃ¡nÃ­)"},{code:"063",label:"Omrzliny"},{code:"069",label:"JinÃ© typy popÃ¡lenin, opaÅ™enin a omrzlin"},{code:"070",label:"Otravy a infekce"},{code:"071",label:"AkutnÃ­ otravy"},{code:"072",label:"AkutnÃ­ infekce"},{code:"079",label:"JinÃ© typy otrav a infekcÃ­"},{code:"080",label:"TonutÃ­ a duÅ¡enÃ­"},{code:"081",label:"DuÅ¡enÃ­"},{code:"082",label:"TonutÃ­ bez smrtelnÃ½ch nÃ¡sledkÅ¯"},{code:"089",label:"JinÃ© typy tonutÃ­ a duÅ¡enÃ­"},{code:"090",label:"ÃšÄinky zvuku, vibracÃ­ a tlaku"},{code:"091",label:"AkutnÃ­ ztrÃ¡ta sluchu"},{code:"092",label:"PÅ¯sobenÃ­ tlaku (barotrauma)"},{code:"099",label:"JinÃ© ÃºÄinky zvuku, vibracÃ­ a tlaku"},{code:"100",label:"ÃšÄinky extrÃ©mnÃ­ch teplot, svÄ›tla a ozÃ¡Å™enÃ­"},{code:"101",label:"ÃšÅ¾eh z tepla a sluneÄnÃ­ho zÃ¡Å™enÃ­"},{code:"102",label:"ÃšÄinky ozÃ¡Å™enÃ­ (netepelnÃ©)"},{code:"103",label:"ÃšÄinky snÃ­Å¾enÃ© teploty"},{code:"109",label:"JinÃ© ÃºÄinky extrÃ©mnÃ­ch teplot, svÄ›tla a ozÃ¡Å™enÃ­"},{code:"110",label:"Å ok"},{code:"111",label:"Å oky po agresÃ­ch a hrozbÃ¡ch"},{code:"112",label:"TraumatickÃ© Å¡oky"},{code:"119",label:"JinÃ© typy Å¡okÅ¯"},{code:"120",label:"VÃ­cenÃ¡sobnÃ© zranÄ›nÃ­"},{code:"999",label:"JinÃ¡ specifickÃ¡ zranÄ›nÃ­ nezahrnutÃ¡ do jinÃ½ch kategoriÃ­"}];
const ESAW_BODY=[{code:"00",label:"ZranÄ›nÃ¡ ÄÃ¡st tÄ›la nespecifikovanÃ¡"},{code:"10",label:"Hlava bez podrobnÄ›jÅ¡Ã­ho rozliÅ¡enÃ­, dÃ¡le nespecifikovanÃ¡"},{code:"11",label:"Hlava, mozek, lebeÄnÃ­ nervy a cÃ©vy"},{code:"12",label:"TvÃ¡Å™"},{code:"13",label:"Oko"},{code:"14",label:"Ucho"},{code:"15",label:"Zuby"},{code:"18",label:"Hlava â€“ vÃ­ce postiÅ¾enÃ½ch oblastÃ­"},{code:"19",label:"Hlava â€“ jinÃ© ÄÃ¡sti vÃ½Å¡e neuvedenÃ©"},{code:"20",label:"Krk vÄetnÄ› pÃ¡teÅ™e a krÄnÃ­ch obratlÅ¯"},{code:"21",label:"Krk vÄetnÄ› pÃ¡teÅ™e a krÄnÃ­ch obratlÅ¯"},{code:"29",label:"Krk â€“ jinÃ© ÄÃ¡sti dosud neuvedenÃ©"},{code:"30",label:"ZÃ¡da vÄetnÄ› pÃ¡teÅ™e a zÃ¡dovÃ½ch obratlÅ¯"},{code:"31",label:"ZÃ¡da vÄetnÄ› pÃ¡teÅ™e a zÃ¡dovÃ½ch obratlÅ¯"},{code:"39",label:"ZÃ¡da â€“ jinÃ© ÄÃ¡sti vÃ½Å¡e neuvedenÃ©"},{code:"40",label:"Trup a orgÃ¡ny bez podrobnÄ›jÅ¡Ã­ho rozliÅ¡enÃ­"},{code:"41",label:"HrudnÃ­ koÅ¡, Å¾ebra vÄetnÄ› kloubÅ¯ a lopatek"},{code:"42",label:"Oblast hrudnÃ­ku vÄetnÄ› orgÃ¡nÅ¯"},{code:"43",label:"PÃ¡nevnÃ­ a bÅ™iÅ¡nÃ­ oblast vÄetnÄ› orgÃ¡nÅ¯"},{code:"48",label:"Trup â€“ vÃ­ce postiÅ¾enÃ½ch oblastÃ­"},{code:"49",label:"Trup â€“ jinÃ© ÄÃ¡sti vÃ½Å¡e neuvedenÃ©"},{code:"50",label:"HornÃ­ konÄetiny bez podrobnÄ›jÅ¡Ã­ho rozliÅ¡enÃ­"},{code:"51",label:"Rameno a ramennÃ­ klouby"},{code:"52",label:"Ruka vÄetnÄ› lokte"},{code:"53",label:"Ruka od zÃ¡pÄ›stÃ­ dolÅ¯"},{code:"54",label:"Prst"},{code:"55",label:"ZÃ¡pÄ›stÃ­"},{code:"58",label:"HornÃ­ konÄetiny â€“ vÃ­ce postiÅ¾enÃ½ch oblastÃ­"},{code:"59",label:"HornÃ­ konÄetiny â€“ jinÃ© ÄÃ¡sti vÃ½Å¡e neuvedenÃ©"},{code:"60",label:"DolnÃ­ konÄetiny bez podrobnÄ›jÅ¡Ã­ho rozliÅ¡enÃ­"},{code:"61",label:"Bedra, bedernÃ­ klouby"},{code:"62",label:"Noha vÄetnÄ› kolena"},{code:"63",label:"KotnÃ­k"},{code:"64",label:"Noha od kotnÃ­ku dolÅ¯"},{code:"65",label:"Prst na noze"},{code:"68",label:"DolnÃ­ konÄetiny â€“ vÃ­ce postiÅ¾enÃ½ch oblastÃ­"},{code:"69",label:"DolnÃ­ konÄetiny â€“ jinÃ© ÄÃ¡sti vÃ½Å¡e neuvedenÃ©"},{code:"70",label:"CelÃ© tÄ›lo a vÃ­ce oblastÃ­ bez podrobnÄ›jÅ¡Ã­ho rozliÅ¡enÃ­"},{code:"71",label:"CelÃ© tÄ›lo (systÃ©movÃ© ÃºÄinky)"},{code:"78",label:"TÄ›lo â€“ vÃ­ce postiÅ¾enÃ½ch oblastÃ­"},{code:"79",label:"TÄ›lo â€“ jinÃ¡ zranÄ›nÃ¡ ÄÃ¡st tÄ›la vÃ½Å¡e neuvedenÃ¡"}];

/* ===== SvÄ›dci ===== */
let svedekId=0;
function addSvedek(valueDate="", valueName=""){
  const root=document.getElementById('svedci-list'); if(!root) return;
  const id=++svedekId;
  const row=document.createElement('div'); row.className='list-item'; row.id='svedek-'+id;
  row.style.display="grid"; row.style.gridTemplateColumns="1fr 2fr auto"; row.style.gap="8px"; row.style.margin="6px 0";
  row.innerHTML =
   `<div class="field">
      <label for="sv-${id}-date">Datum</label>
      <input id="sv-${id}-date" type="date" value="${valueDate}">
      <button class="picker-btn" type="button" onclick="openPicker('sv-${id}-date')" title="OtevÅ™Ã­t kalendÃ¡Å™">ğŸ“…</button>
    </div>
    <div class="field">
      <label for="sv-${id}-name">JmÃ©no a pÅ™Ã­jmenÃ­ svÄ›dka</label>
      <input id="sv-${id}-name" value="${valueName}" placeholder="NapÅ™.: Jan NovÃ¡k">
    </div>
    <div class="actions" style="display:flex;align-items:end">
      <button type="button" class="ghost btn-del-svedek" onclick="delSvedek(${id})">âœ–ï¸</button>
    </div>`;
  root.appendChild(row);
  autosaveDebounced();
}
function delSvedek(id){ const el=document.getElementById('svedek-'+id); if(el) el.remove(); autosaveDebounced(); }

/* ===== Validace ===== */
function clearErrors(){
  document.querySelectorAll('.error').forEach(el=>el.classList.remove('error'));
  document.querySelectorAll('.error-msg').forEach(m=>{m.classList.add('hidden'); m.textContent='';});
}
function showError(el,msg){
  if(!el) return;
  el.classList.add('error');
  const box=el.closest('.field'); const m=box?.querySelector('.error-msg'); if(m){ m.textContent=msg; m.classList.remove('hidden'); }
}
function validateSectionA(){
  let ok=true;
  const aZ=document.getElementById('a-zam'), aI=document.getElementById('a-ico'), aS=document.getElementById('a-sidlo');
  const z2=document.getElementById('a-zam2'), i2=document.getElementById('a-ico2'), s2=document.getElementById('a-sidlo2');
  const anyOther = !isEmpty(z2.value) || !isEmpty(i2.value) || !isEmpty(s2.value);
  if (anyOther){
    if (isEmpty(z2.value)){ showError(z2,'VyplÅˆte nÃ¡zev jinÃ©ho zamÄ›stnavatele.'); ok=false; }
    if (isEmpty(i2.value)){ showError(i2,'VyplÅˆte IÄŒO jinÃ©ho zamÄ›stnavatele.'); ok=false; }
    if (isEmpty(s2.value)){ showError(s2,'VyplÅˆte sÃ­dlo jinÃ©ho zamÄ›stnavatele.'); ok=false; }
    aZ.value=""; aI.value=""; aS.value="";
  } else {
    if (isEmpty(aZ.value)){ showError(aZ,'ChybÃ­ nÃ¡zev zamÄ›stnavatele.'); ok=false; }
    if (isEmpty(aI.value)){ showError(aI,'ChybÃ­ IÄŒO zamÄ›stnavatele.'); ok=false; }
    if (isEmpty(aS.value)){ showError(aS,'ChybÃ­ sÃ­dlo zamÄ›stnavatele.'); ok=false; }
  }
  return ok;
}
function validateRequired(){
  clearErrors(); let ok=true; let firstErr=null;

  if (!validateSectionA()) ok=false;

  [['b-jmeno','VyplÅˆte jmÃ©no a pÅ™Ã­jmenÃ­.'],
   ['b-datum','Vyberte datum narozenÃ­.'],
   ['b-prace','VyplÅˆte druh prÃ¡ce.'],
   ['b-status','Vyberte status postiÅ¾enÃ©ho.']].forEach(([id,msg])=>{
     const el=document.getElementById(id);
     if(!el || !el.value){ showError(el,msg); ok=false; if(!firstErr) firstErr=el; }
  });

  [['c-datum','Zadejte datum a Äas Ãºrazu.'],
   ['c-hodiny','UveÄte poÄet hodin.'],
   ['c-pocet','UveÄte poÄet zranÄ›nÃ½ch osob.'],
   ['c-druh-urazu','Vyberte druh Ãºrazu.'],
   ['c-druh-zraneni','Vyberte druh zranÄ›nÃ­ (ESAW).'],
   ['c-cast-tela','Vyberte zranÄ›nou ÄÃ¡st tÄ›la (ESAW).'],
   ['c-cinnost','VyplÅˆte Äinnost.'],
   ['c-misto','VyplÅˆte mÃ­sto.'],
   ['c-pracoviste','Vyberte ANO/NE.'],
   ['c-popis','VyplÅˆte popis dÄ›je.'],
   ['c-dech','Vyberte ANO/NE.']].forEach(([id,msg])=>{
     const el=document.getElementById(id);
     if(!el || !el.value){ showError(el,msg); ok=false; if(!firstErr) firstErr=el; }
  });

  const zdroj=document.getElementById('c-zdroj'), pric=document.getElementById('c-priciny');
  if(!(zdroj?.selectedOptions?.length>0)){ showError(zdroj,'Vyberte alespoÅˆ jednu moÅ¾nost.'); ok=false; if(!firstErr) firstErr=zdroj; }
  if(!(pric?.selectedOptions?.length>0)){ showError(pric,'Vyberte alespoÅˆ jednu moÅ¾nost.'); ok=false; if(!firstErr) firstErr=pric; }

  const banner = document.getElementById('val-banner');
  if (!ok) { showValidationBanner(firstErr); }
  else if (banner) { banner.style.display = 'none'; }

  return ok;
}

/* ===== SbÄ›r dat ===== */
function getVal(id){ const el=document.getElementById(id); return el && 'value' in el ? (el.value||'').trim() : ''; }
function getMulti(id){ const el=document.getElementById(id); return el ? Array.from(el.selectedOptions).map(o=>o.textContent.trim()) : []; }
function byCode(arr, code){ return arr.find(x=>x.code===code)||null; }
function updatePrintMirrors(){
  const zd=document.getElementById('m-zdroj'); if(zd) zd.textContent=getMulti('c-zdroj').join('; ')||'â€”';
  const pr=document.getElementById('m-priciny'); if(pr) pr.textContent=getMulti('c-priciny').join('; ')||'â€”';
  const e1=getVal('a-zam2'), e2=getVal('a-ico2'), e3=getVal('a-sidlo2');
  const det=document.getElementById('opt-employer'); if(det){ det.classList.toggle('print-hide', !(e1||e2||e3)); }
}
function collectData(){
  const svedci=[]; document.querySelectorAll('#svedci-list .list-item').forEach(row=>{
    const date=row.querySelector('input[type="date"]')?.value||""; const name=row.querySelector('input[type="text"]')?.value||"";
    if(date || name) svedci.push({date,name});
  });
  const d={
    A_Zamestnavatel:getVal('a-zam'), A_Sidlo:getVal('a-sidlo'), A_ICO:getVal('a-ico'),
    A_JinyZam:getVal('a-zam2'), A_JinyICO:getVal('a-ico2'), A_JineSidlo:getVal('a-sidlo2'),
    B_Jmeno:getVal('b-jmeno'), B_DatumNarozeni:getVal('b-datum'), B_DruhPrace:getVal('b-prace'), B_Status:getVal('b-status'),
    C_DatumCas:getVal('c-datum'), C_HodinyPred:getVal('c-hodiny'), C_PocetZr:getVal('c-pocet'), C_DruhUrazu:getVal('c-druh-urazu'),
    C_DruhZraneniKod:getVal('c-druh-zraneni'), C_CastTelaKod:getVal('c-cast-tela'),
    C_Cinnost:getVal('c-cinnost'), C_Misto:getVal('c-misto'), C_PravPracoviste:getVal('c-pracoviste'),
    C_Zdroj:getMulti('c-zdroj'), C_Priciny:getMulti('c-priciny'), C_Popis:getVal('c-popis'), C_Dech:getVal('c-dech'),
    D_DatumPodpisPostizeneho:getVal('d-datum-podpis'), D_Svedci:svedci, D_Zapisujici:getVal('d-zapis')
  };
  const inj=byCode(ESAW_INJURY,d.C_DruhZraneniKod), bod=byCode(ESAW_BODY,d.C_CastTelaKod);
  d.C_DruhZraneniPopis=inj?inj.label:""; d.C_CastTelaPopis=bod?bod.label:"";
  return d;
}

/* ===== UloÅ¾enÃ­/Obnova ===== */
function saveToStorage(){try{localStorage.setItem(STORAGE_FORM, JSON.stringify(collectData()));}catch(e){}}
function restoreFromStorage(){
  try{
    const raw=localStorage.getItem(STORAGE_FORM); if(!raw) return;
    const d=JSON.parse(raw);
    document.getElementById('a-zam').value=d.A_Zamestnavatel ?? DEF_A.zam;
    document.getElementById('a-ico').value=d.A_ICO ?? DEF_A.ico;
    document.getElementById('a-sidlo').value=d.A_Sidlo ?? DEF_A.sidlo;
    document.getElementById('a-zam2').value=d.A_JinyZam ?? "";
    document.getElementById('a-ico2').value=d.A_JinyICO ?? "";
    document.getElementById('a-sidlo2').value=d.A_JineSidlo ?? "";
    otherEmployerChanged();

    document.getElementById('b-jmeno').value=d.B_Jmeno ?? "";
    document.getElementById('b-datum').value=d.B_DatumNarozeni ?? "";
    document.getElementById('b-prace').value=d.B_DruhPrace ?? "";
    document.getElementById('b-status').value=d.B_Status ?? "";

    document.getElementById('c-datum').value=d.C_DatumCas ?? "";
    document.getElementById('c-hodiny').value=d.C_HodinyPred ?? "";
    document.getElementById('c-pocet').value=d.C_PocetZr ?? "";
    document.getElementById('c-druh-urazu').value=d.C_DruhUrazu ?? "";
    document.getElementById('c-druh-zraneni').value=d.C_DruhZraneniKod ?? "";
    document.getElementById('c-cast-tela').value=d.C_CastTelaKod ?? "";
    document.getElementById('c-cinnost').value=d.C_Cinnost ?? "";
    document.getElementById('c-misto').value=d.C_Misto ?? "";
    document.getElementById('c-pracoviste').value=d.C_PravPracoviste ?? "";

    const setMultiByText=(id,items)=>{const el=document.getElementById(id);const set=new Set((items||[]).map(s=>String(s).trim()));Array.from(el.options).forEach(o=>o.selected=set.has(o.textContent.trim()));}
    setMultiByText('c-zdroj', d.C_Zdroj ?? []);
    setMultiByText('c-priciny', d.C_Priciny ?? []);

    document.getElementById('c-popis').value=d.C_Popis ?? "";
    document.getElementById('c-dech').value=d.C_Dech ?? "";

    const root=document.getElementById('svedci-list'); root.innerHTML=''; svedekId=0;
    (Array.isArray(d.D_Svedci)&&d.D_Svedci.length? d.D_Svedci : [{date:'',name:''}]).forEach(s=>addSvedek(s.date||'', s.name||''));
    document.getElementById('d-datum-podpis').value=d.D_DatumPodpisPostizeneho ?? "";
    document.getElementById('d-zapis').value=d.D_Zapisujici ?? "";
  }catch(e){}
}
function debounce(fn,t=300){let h;return(...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),t);};}
const autosaveDebounced=debounce(saveToStorage,300);

/* ===== Sekce A â€“ defaulty vs. jinÃ½ zamÄ›stnavatel ===== */
function captureDefaultsA(){
  DEF_A={ zam:document.getElementById('a-zam').value, ico:document.getElementById('a-ico').value, sidlo:document.getElementById('a-sidlo').value };
}
function otherEmployerChanged(){
  const z2=getVal('a-zam2'), i2=getVal('a-ico2'), s2=getVal('a-sidlo2');
  const any=!!(z2||i2||s2);
  const aZ=document.getElementById('a-zam'), aI=document.getElementById('a-ico'), aS=document.getElementById('a-sidlo');
  if(any){ aZ.value=""; aI.value=""; aS.value=""; } else { aZ.value=DEF_A.zam; aI.value=DEF_A.ico; aS.value=DEF_A.sidlo; }
}

/* ===== Logo â†’ dataURL ===== */
async function loadLogoDataURL(){
  const img=document.getElementById('brand-logo'); if(!img) return "";
  if(!img.src) img.src=LOGO_SRC;
  if(!img.complete || !img.naturalWidth){ await new Promise(res=>{ img.onload=res; img.onerror=res; }); }
  try{ const cv=document.createElement('canvas'); cv.width=img.naturalWidth; cv.height=img.naturalHeight; cv.getContext('2d').drawImage(img,0,0); return cv.toDataURL('image/png'); }catch(_){ return ""; }
}
function dataURLParts(durl){ const m=/^data:([^;]+);base64,(.*)$/i.exec(durl||""); return m?{mime:m[1],base64:m[2]}:null; }

/* ===== Word (.doc MHTML) ===== */
function buildReadablePairs(d){
  const R=[]; const H=t=>R.push([t,""]); const P=(k,v)=>R.push([k,v||""]);
  H("A) Ãšdaje o zamÄ›stnavateli"); P("NÃ¡zev zamÄ›stnavatele",d.A_Zamestnavatel); P("SÃ­dlo (adresa)",d.A_Sidlo); P("IÄŒO",d.A_ICO);
  if(d.A_JinyZam||d.A_JinyICO||d.A_JineSidlo){ P("JinÃ½ zamÄ›stnavatel",d.A_JinyZam); P("IÄŒO (jinÃ½)",d.A_JinyICO); P("SÃ­dlo (jinÃ½)",d.A_JineSidlo); }
  H("B) Ãšdaje o postiÅ¾enÃ©m"); P("JmÃ©no a pÅ™Ã­jmenÃ­",d.B_Jmeno); P("Datum narozenÃ­",d.B_DatumNarozeni); P("Druh prÃ¡ce",d.B_DruhPrace); P("PostiÅ¾enÃ½ je",d.B_Status);
  H("C) Ãšdaje o Ãºrazu"); P("Datum a Äas Ãºrazu",d.C_DatumCas); P("Hodiny pÅ™ed Ãºrazem",d.C_HodinyPred); P("PoÄet zranÄ›nÃ½ch osob",d.C_PocetZr); P("Druh Ãºrazu",d.C_DruhUrazu);
  P("Druh zranÄ›nÃ­ (kÃ³d â€“ popis)", d.C_DruhZraneniKod? `${d.C_DruhZraneniKod} â€” ${d.C_DruhZraneniPopis}`:"");
  P("ZranÄ›nÃ¡ ÄÃ¡st tÄ›la (kÃ³d â€“ popis)", d.C_CastTelaKod? `${d.C_CastTelaKod} â€” ${d.C_CastTelaPopis}`:"");
  P("ÄŒinnost",d.C_Cinnost); P("MÃ­sto Ãºrazu",d.C_Misto); P("PravidelnÃ© pracoviÅ¡tÄ›",d.C_PravPracoviste);
  P("Zdroj Ãºrazu (vÃ­ce)",d.C_Zdroj.join("; ")); P("PÅ™Ã­Äiny (vÃ­ce)",d.C_Priciny.join("; ")); P("Popis dÄ›je",d.C_Popis); P("DechovÃ¡ zkouÅ¡ka",d.C_Dech);
  H("D) PotvrzujÃ­cÃ­ Ãºdaje"); P("Datum/podpis postiÅ¾enÃ©ho",d.D_DatumPodpisPostizeneho);
  (d.D_Svedci||[]).forEach((s,i)=>P(`SvÄ›dek ${i+1}`,(s.date? s.date+" â€“ ":"")+(s.name||""))); P("ZapisujÃ­cÃ­ zamÄ›stnanec",d.D_Zapisujici);
  return R;
}
function buildMhtmlHtmlBody(rows, hasLogo){
  return `
  <html><head><meta charset="utf-8">
    <style>
      @page Section1 { size:595.3pt 841.9pt; margin:28.35pt; }
      div.Section1 { page:Section1; }
      body{font-family:Segoe UI,Arial,sans-serif;color:#111}
      h1{font-size:18pt;margin:0 0 10pt 0}
      .logo{margin:0 0 8pt 0}
      table{border-collapse:collapse;width:100%}
      td{border:1px solid #ddd;padding:6pt;vertical-align:top}
      td.k{width:34%;background:#f3f4f6;font-weight:700}
      .sec{background:#e5e7eb;font-weight:700;text-transform:uppercase}
    </style>
  </head>
  <body><div class="Section1">
    ${hasLogo ? `<div class="logo">cid:logo1</div>` : ``}
    <h1>ZÃ¡znam o pracovnÃ­m Ãºrazu</h1>
    <table>
      ${rows.map(([k,v])=> v==="" ? `<tr><td class="sec" colspan="2">${k}</td></tr>` : `<tr><td class="k">${k}</td><td>${String(v||"").replace(/</g,"&lt;")}</td></tr>`).join("")}
    </table>
  </div></body></html>`;
}
async function buildDocMhtmlBlob(){
  const d = collectData(); const rows = buildReadablePairs(d);
  const composeDate=todayLocalISO(); const victimName=safeFileName(d.B_Jmeno); const fileName=`${victimName} - ${composeDate}.doc`;
  const logoDataURL=await loadLogoDataURL(); const hasLogo=!!logoDataURL; const htmlBody=buildMhtmlHtmlBody(rows, hasLogo);
  const boundary="----=_NextPart_"+Date.now();
  let mhtml=""; mhtml+="MIME-Version: 1.0\r\n"; mhtml+=`Content-Type: multipart/related; type="text/html"; boundary="${boundary}"\r\n\r\n`;
  mhtml+=`--${boundary}\r\nContent-Type: text/html; charset="utf-8"\r\nContent-Transfer-Encoding: 8bit\r\n\r\n${htmlBody}\r\n\r\n`;
  if(hasLogo){ const p=dataURLParts(logoDataURL); const base64=(p.base64.match(/.{1,76}/g)||[p.base64]).join("\r\n");
    mhtml+=`--${boundary}\r\nContent-Type: ${p.mime}\r\nContent-Transfer-Encoding: base64\r\nContent-Location: logo1\r\nContent-ID: <logo1>\r\n\r\n${base64}\r\n\r\n`;
  }
  mhtml+=`--${boundary}--`;
  const blob=new Blob([mhtml],{type:"application/msword;charset=utf-8"});
  return { blob, fileName };
}

/* ===== PÅ™Ã­jemci, OWA-only & nastavenÃ­ ===== */
function getRecipients(){
  try{const raw=localStorage.getItem(STORAGE_RECIPIENTS);const arr=raw?JSON.parse(raw):null;if(Array.isArray(arr)&&arr.length>0) return arr;}catch(_){}
  return ['jana.charvatova@le-co.cz'];
}
function setRecipients(list){ localStorage.setItem(STORAGE_RECIPIENTS, JSON.stringify(list)); }
function getOwaOnly(){ try{ return localStorage.getItem(STORAGE_OWA_ONLY)==="1"; }catch(_){ return false; } }
function setOwaOnly(flag){ try{ localStorage.setItem(STORAGE_OWA_ONLY, flag ? "1" : "0"); }catch(_){ } }

function renderRecipientsChips(container,list){
  container.innerHTML=""; list.forEach((email,idx)=>{ const chip=document.createElement('span');
    chip.style.cssText="display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:13px";
    chip.textContent=email+" "; const btn=document.createElement('button'); btn.type="button"; btn.textContent="âœ–"; btn.title="Odebrat";
    btn.style.cssText="margin-left:6px;border:0;background:transparent;cursor:pointer;color:#111";
    btn.onclick=()=>{list.splice(idx,1);renderRecipientsChips(container,list);};
    chip.appendChild(btn); container.appendChild(chip);
  });
}
function openSettings(){
  const pass=prompt("Zadejte heslo pro nastavenÃ­ (4 ÄÃ­sla):"); if(pass!=="1991"){ alert("NesprÃ¡vnÃ© heslo."); return; }
  const dlg=document.getElementById('dlg-settings'); const list=getRecipients().slice();
  dlg.dataset.work=JSON.stringify(list); renderRecipientsChips(document.getElementById('recipients-list'), list);
  document.getElementById('inp-email-add').value="";
  document.getElementById('inp-owa-only').checked = getOwaOnly();
  dlg.showModal();
}
function addRecipientFromInput(){
  const dlg=document.getElementById('dlg-settings'); const list=JSON.parse(dlg.dataset.work||"[]");
  const inp=document.getElementById('inp-email-add'); const v=(inp.value||"").trim(); const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!re.test(v)){ alert("Zadejte platnÃ½ eâ€‘mail."); return; } if(!list.includes(v)) list.push(v); dlg.dataset.work=JSON.stringify(list);
  renderRecipientsChips(document.getElementById('recipients-list'), list); inp.value="";
}
function saveSettings(){
  const dlg=document.getElementById('dlg-settings');
  const list=JSON.parse(dlg.dataset.work||"[]").filter(Boolean);
  if(!list.length){ alert("MusÃ­ bÃ½t alespoÅˆ jeden pÅ™Ã­jemce."); return; }
  setRecipients(list);
  setOwaOnly(document.getElementById('inp-owa-only').checked);
  dlg.close();
  alert("NastavenÃ­ uloÅ¾eno.\nPÅ™Ã­jemci: " + list.join(", ") + "\nVÅ¾dy pouÅ¾Ã­t OWA: " + (getOwaOnly() ? "ANO" : "NE"));
}

/* ===== Akce tlaÄÃ­tek ===== */
async function onSaveDocWord(){
  if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; }
  const { blob, fileName } = await buildDocMhtmlBlob();
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
}
function openOwaComposeWithRecipientsAndSubject(subject){
  const recipients=getRecipients();
  const url=`https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(recipients.join(','))}&subject=${encodeURIComponent(subject)}`;
  window.open(url,"_blank","noopener");
}
async function onSendMail(){
  if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; }
  const { blob, fileName } = await buildDocMhtmlBlob();
  const file = new File([blob], fileName, { type: "application/msword" });
  const subject = buildEmailSubject();

  // Volba "VÅ¾dy pouÅ¾Ã­t OWA"
  if (getOwaOnly()){
    try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);}catch(_){}
    openOwaComposeWithRecipientsAndSubject(subject);
    return;
  }

  // Web Share API (HTTPS; dostupnost cÃ­le zÃ¡visÃ­ na OS). PÅ™idÃ¡me i url, coÅ¾ Windows nÄ›kdy vyÅ¾aduje.
  if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
    try{
      await navigator.share({ files:[file], title:"ZÃ¡znam o pracovnÃ­m Ãºrazu", url: location.href });
      return;
    }catch(e){ console.warn("Share zruÅ¡eno/selhalo:", e); /* pokraÄuj fallbackem */ }
  }

  // Fallback: stÃ¡hnout soubor + otevÅ™Ã­t OWA s pÅ™Ã­jemci/pÅ™edmÄ›tem
  try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);}catch(_){}
  alert("SdÃ­lenÃ­ do Outlooku nenÃ­ dostupnÃ©. Soubor byl uloÅ¾en â€“ otevÅ™u Outlook na webu s pÅ™Ã­jemci a pÅ™edmÄ›tem (pÅ™Ã­lohu pÅ™etÃ¡hnÄ›te do okna zprÃ¡vy).");
  openOwaComposeWithRecipientsAndSubject(subject);
}

function onPrint(){ if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; } updatePrintMirrors(); window.print(); }
function onClear(){
  const ok=confirm("Opravdu chcete smazat celÃ½ formulÃ¡Å™ vÄetnÄ› uloÅ¾enÃ½ch dat?\nTuto akci nelze vrÃ¡tit zpÄ›t."); if(!ok) return;
  const form=document.getElementById('form-uraz'); form.reset(); localStorage.removeItem(STORAGE_FORM);
  otherEmployerChanged(); const root=document.getElementById('svedci-list'); root.innerHTML=''; svedekId=0; addSvedek(); clearErrors();
}

/* ===== PÅ™edmÄ›t zprÃ¡vy ===== */
function buildEmailSubject(){ const d=collectData(); const nm=d.B_Jmeno||"neuvedeno"; const dt=todayLocalISO(); return `Kniha ÃºrazÅ¯ / ${nm}, ${dt}`; }

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const img=document.getElementById('brand-logo'); if(img) img.src=LOGO_SRC;
  captureDefaultsA();

  // NaplnÄ›nÃ­ ESAW
  const fill=(selId,arr)=>{ const sel=document.getElementById(selId); if(!sel) return;
    sel.innerHTML='<option value="" disabled selected>â€” vyberte â€”</option>';
    arr.forEach(x=>{ const o=document.createElement('option'); o.value=x.code; o.textContent=`${x.code} â€” ${x.label}`; sel.appendChild(o); });
  };
  fill('c-druh-zraneni', ESAW_INJURY); fill('c-cast-tela',  ESAW_BODY);

  // Autosave
  const form=document.getElementById('form-uraz');
  form.addEventListener('input', autosaveDebounced);
  form.addEventListener('change', autosaveDebounced);

  // JinÃ½ zamÄ›stnavatel â€“ pÅ™epÃ­nÃ¡nÃ­
  ['a-zam2','a-ico2','a-sidlo2'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', ()=>{ otherEmployerChanged(); autosaveDebounced(); });
    el.addEventListener('change', ()=>{ otherEmployerChanged(); autosaveDebounced(); });
  });

  // SvÄ›dek â€“ prÃ¡zdnÃ¡ Å™Ã¡dka
  if(!document.getElementById('svedci-list').children.length){ addSvedek(); }

  // Obnova dat
  restoreFromStorage();
});

/* ===== Tisk â€“ zrcadlenÃ­ multi-select ===== */
function onBeforePrint(){ updatePrintMirrors(); }
if(window.matchMedia){
  const mql=window.matchMedia('print');
  (mql.addEventListener ? mql.addEventListener('change',e=>{ if(e.matches) onBeforePrint(); })
                        : mql.addListener(e=>{ if(e.matches) onBeforePrint(); }));
}
window.onbeforeprint=onBeforePrint;

/* ===== PÅ™ipnutÃ­ funkcÃ­ na window (pro jistotu) ===== */
window.onPrint = onPrint;
window.onSaveDocWord = onSaveDocWord;
window.onSendMail = onSendMail;
window.onClear = onClear;
window.openSettings = openSettings;
window.addRecipientFromInput = addRecipientFromInput;
window.saveSettings = saveSettings;
window.openPicker = openPicker;
</script>
</body>
</html>