<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formul√°≈ô ‚Äì Pracovn√≠ √∫raz (A‚ÄìD)</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --text:#111827;
    --accent:#2563eb; --accent-2:#0ea5e9; --border:#e5e7eb; --field:#ffffff;
    --danger:#ef4444; --danger-bg:#fee2e2; --danger-border:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

  header{
    position:sticky;top:0;z-index:5;padding:16px 18px;border-bottom:1px solid var(--border);
    background:linear-gradient(90deg,#ffffffd9,#f8fafcd9);
    backdrop-filter:saturate(1.1) blur(4px)
  }
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{margin:0 0 4px;font-size:28px}
  .subtitle{color:var(--muted);font-size:14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;align-items:flex-start}
  button{
    appearance:none;border:1px solid transparent;border-radius:10px;padding:10px 14px;color:#fff;cursor:pointer;font-weight:700;
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 6px 14px rgba(37,99,235,.22);
    transition:transform .06s ease,box-shadow .2s ease
  }
  button.word{background:linear-gradient(135deg,#4f46e5,#06b6d4); box-shadow:0 6px 16px rgba(79,70,229,.28)}
  button.ghost{background:#f8fafc;color:#111827;border:1px solid var(--border)}
  button:hover{transform:translateY(-1px)}
  .hint{font-size:12.5px;color:#4b5563;margin-top:6px;max-width:380px}

  .grid{display:grid;gap:16px;grid-template-columns:repeat(12,minmax(0,1fr))}
  .card{grid-column:1/-1;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 14px}
  .card h2{margin:0 0 10px;font-size:18px;font-weight:800;display:flex;align-items:center;gap:10px}
  .badge{display:inline-grid;place-items:center;min-width:32px;min-height:32px;border-radius:8px;font-weight:900;background:#eef2ff;border:1px solid #e5e7eb;color:#1f2937}
  .row{display:grid;gap:10px;grid-template-columns:repeat(12,minmax(0,1fr))}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}

  label{display:block;margin-bottom:6px;color:#111827;font-weight:800;font-size:15px}
  .field{position:relative}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #cbd5e1;background:var(--field);color:var(--text);outline:none}
  textarea{min-height:110px;resize:vertical}
  .muted{color:var(--muted);font-size:13px}
  .req:after{content:" *";color:#dc2626}
  .help{margin-top:6px;font-size:12.5px;color:#4b5563}

  .lock{background:#f8fafc;border-color:#e5e7eb;color:#111827}
  .lock[readonly]{cursor:not-allowed}
  .picker-btn{position:absolute;right:8px;top:8px;border-radius:8px;border:1px solid #cbd5e1;background:#f9fafb;color:#111827;padding:6px 8px;cursor:pointer}
  .picker-btn:hover{filter:brightness(1.05)}

  .brand{display:flex;align-items:center;gap:14px;margin:6px 0 12px 0}
  .brand img{height:56px;display:block}

  .error{border-color:var(--danger-border)!important;background:var(--danger-bg)!important}
  .error-msg{margin-top:6px;color:#991b1b;font-size:12px}
  .hidden{display:none}

  /* Banner validace */
  #val-banner{
    display:none; margin:10px 0 0 0; padding:10px 12px;
    background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; border-radius:8px; font-weight:700;
  }

  /* Tisk */
  .print-only{display:none}
  @media print{
    header,.toolbar,.picker-btn,.error-msg,#val-banner{display:none !important}
    .card{box-shadow:none;border-color:#ddd;background:white;color:#111}
    body{background:white;color:#111}
    input,select,textarea{background:white;color:#111;border-color:#bbb}
    .badge{background:#f3f4f6;border-color:#e5e7eb;color:#111}
    #c-zdroj,#c-priciny{display:none !important}
    #m-zdroj,#m-priciny{display:block !important}
    .help{display:none !important}
    a[href]:after{content:"" !important}
    .print-hide{display:none !important}
    .btn-del-svedek,.btn-add-svedek{display:none !important}
    #btn-settings,#dlg-settings{display:none !important}
  }

  @media (max-width:900px){.col-6,.col-4,.col-3{grid-column:span 12}}

  /* ‚öôÔ∏è Nastaven√≠ ‚Äì p≈ôesn√© vyst≈ôedƒõn√≠ ikony */
  #btn-settings{
    position:fixed;top:12px;right:12px;z-index:20;
    border:1px solid var(--border); background:#ffffffcc;color:#111827;
    border-radius:50%; width:38px;height:38px;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
    padding:0; line-height:1; font-size:18px;
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Formul√°≈ô ‚Äì z√°znam o pracovn√≠m √∫razu</h1>
    <div class="subtitle">Sekce A‚ÄìD ‚Ä¢ tisk ‚Ä¢ export do Wordu (.doc) ‚Ä¢ odesl√°n√≠ e‚Äëmailem</div>

    <div class="toolbar">
      <button type="button" onclick="onPrint()">üñ®Ô∏è Vytisknout</button>

      <!-- Rozdƒõlen√© akce -->
      <div style="display:flex;flex-direction:column">
        <button type="button" class="word" onclick="onSaveDocWord()">üìù Ulo≈æit do Wordu (.doc)</button>
      </div>

      <div style="display:flex;flex-direction:column">
        <button type="button" class="word" onclick="onSendMail()">üìß Odeslat e‚Äëmailem</button>
        <div class="hint">
          Funguje jen v prohl√≠≈æeƒç√≠ch s <strong>Web Share API</strong> pro soubory
          (nap≈ô. <strong>Edge</strong>, <strong>Chrome</strong> na <strong>Windows 10/11</strong>) a pokud je
          <strong>Outlook</strong> dostupn√Ω jako c√≠l ‚ÄûSd√≠let‚Äú. <em>Firefox</em> nepodporuje.
          (Web Share vy≈æaduje <strong>HTTPS</strong>.)
        </div>
      </div>

      <button type="button" class="ghost" onclick="onClear()">‚ôªÔ∏è Vymazat</button>
    </div>

    <!-- Banner validace -->
    <div id="val-banner" role="alert">Dopl≈àte pros√≠m zv√Ωraznƒõn√° povinn√° pole a zkuste to znovu.</div>
  </div>
</header>

<!-- ‚öôÔ∏è Nastaven√≠ p≈ô√≠jemc≈Ø + OWA-only (heslo 1991) -->
<button type="button" id="btn-settings" title="Nastaven√≠" onclick="openSettings()"><span aria-hidden="true">‚öôÔ∏è</span></button>

<dialog id="dlg-settings" style="border:1px solid #e5e7eb;border-radius:12px;max-width:520px;padding:16px">
  <form method="dialog" onsubmit="return false" style="display:flex;flex-direction:column;gap:10px">
    <h3 style="margin:0 0 6px">Nastaven√≠ e‚Äëmailu</h3>

    <label style="font-weight:700">P≈ô√≠jemci (Komu)</label>
    <p class="muted" style="margin:0 0 8px">Spravujte seznam p≈ô√≠jemc≈Ø. Lze p≈ôidat v√≠ce e‚Äëmail≈Ø.</p>
    <div id="recipients-list" style="display:flex;flex-wrap:wrap;gap:6px"></div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
      <input id="inp-email-add" type="email" placeholder="novy.prijemce@firma.cz"
             style="flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:10px" />
      <button type="button" class="ghost" onclick="addRecipientFromInput()">P≈ôidat</button>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:6px 0">

    <label style="display:flex;gap:10px;align-items:center">
      <input id="inp-owa-only" type="checkbox">
      <span><strong>V≈ædy pou≈æ√≠t OWA (p≈ôeskoƒçit Sd√≠let)</strong><br>
        <span class="muted">St√°hne .doc a otev≈ôe Outlook na webu s vyplnƒõn√Ωmi poli. P≈ô√≠lohu p≈ôet√°hnete do okna zpr√°vy.</span>
      </span>
    </label>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button type="button" class="ghost" onclick="document.getElementById('dlg-settings').close()">Zru≈°it</button>
      <button type="button" class="word" onclick="saveSettings()">Ulo≈æit</button>
    </div>
  </form>
</dialog>

<main class="wrap" id="print-root">
  <!-- Logo -->
  <div class="brand"><img id="brand-logo" alt="LE &amp; CO logo"></div>

  <!-- ====== FORMUL√Å≈ò A‚ÄìD ====== -->
  <form id="form-uraz" class="grid" onsubmit="return false" novalidate>
    <!-- A -->
    <section class="card">
      <h2><span class="badge">A</span> √ödaje o zamƒõstnavateli</h2>
      <div class="row">
        <div class="col-6 field">
          <label class="req" for="a-zam">N√°zev zamƒõstnavatele</label>
          <input id="a-zam" value="LE &amp; CO ‚Äì Ing. Ji≈ô√≠ Lenc, s.r.o." readonly class="lock" title="Uzamƒçeno ‚Äì nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="a-ico">IƒåO</label>
          <input id="a-ico" value="26502658" readonly class="lock" title="Uzamƒçeno ‚Äì nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-12 col-6 field">
          <label class="req" for="a-sidlo">S√≠dlo (adresa)</label>
          <input id="a-sidlo" value="Podƒõbradsk√° 606, Jirny" readonly class="lock" title="Uzamƒçeno ‚Äì nelze upravit">
          <div class="error-msg hidden"></div>
        </div>
      </div>

      <details id="opt-employer" style="margin-top:10px">
        <summary><strong>Jin√Ω zamƒõstnavatel (pokud se jedn√° o zamƒõstnance jin√©ho zamƒõstnavatele)</strong></summary>
        <div class="row" style="margin-top:10px">
          <div class="col-6 field">
            <label class="req" for="a-zam2">N√°zev zamƒõstnavatele</label>
            <input id="a-zam2" placeholder="N√°zev jin√©ho zamƒõstnavatele">
            <div class="error-msg hidden"></div>
          </div>
          <div class="col-3 field">
            <label class="req" for="a-ico2">IƒåO</label>
            <input id="a-ico2" placeholder="IƒåO">
            <div class="error-msg hidden"></div>
          </div>
          <div class="col-12 col-6 field">
            <label class="req" for="a-sidlo2">S√≠dlo (adresa)</label>
            <input id="a-sidlo2" placeholder="Adresa">
            <div class="error-msg hidden"></div>
          </div>
        </div>
      </details>
    </section>

    <!-- B -->
    <section class="card">
      <h2><span class="badge">B</span> √ödaje o posti≈æen√©m</h2>
      <div class="row">
        <div class="col-6 field">
          <label class="req" for="b-jmeno">Jm√©no a p≈ô√≠jmen√≠</label>
          <input id="b-jmeno" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="b-datum">Datum narozen√≠</label>
          <input id="b-datum" type="date" required>
          <button class="picker-btn" type="button" onclick="openPicker('b-datum')" title="Otev≈ô√≠t kalend√°≈ô">üìÖ</button>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="b-prace">Druh pr√°ce</label>
          <input id="b-prace" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="b-status">Posti≈æen√Ω je</label>
          <select id="b-status" required>
            <option value="" disabled selected>‚Äî vyberte ‚Äî</option>
            <option>zamƒõstnanec v pracovn√≠m pomƒõru</option>
            <option>zamƒõstnanec zamƒõstnan√Ω na z√°kladƒõ dohod o prac√≠ch konan√Ωch mimo pracovn√≠ pomƒõr</option>
            <option>zamƒõstnanec jin√©ho zamƒõstnavatele</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>
      </div>
    </section>

    <!-- C -->
    <section class="card">
      <h2><span class="badge">C</span> √ödaje o √∫razu</h2>
      <div class="row">
        <div class="col-3 field">
          <label class="req" for="c-datum">Datum a hodina √∫razu</label>
          <input id="c-datum" type="datetime-local" required>
          <button class="picker-btn" type="button" onclick="openPicker('c-datum')" title="Otev≈ô√≠t kalend√°≈ô">üìÖ</button>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-hodiny">Poƒçet hodin odpracovan√Ωch p≈ôed √∫razem</label>
          <input id="c-hodiny" type="number" min="0" step="0.5" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-pocet">Poƒçet zranƒõn√Ωch osob celkem</label>
          <input id="c-pocet" type="number" min="1" value="1" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-3 field">
          <label class="req" for="c-druh-urazu">Druh √∫razu</label>
          <select id="c-druh-urazu" required>
            <option value="" disabled selected>‚Äî vyberte ‚Äî</option>
            <option>smrteln√Ω</option>
            <option>ostatn√≠</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-druh-zraneni">ƒå√≠seln√Ω k√≥d a druh zranƒõn√≠ (ESAW)</label>
          <select id="c-druh-zraneni" required></select>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="c-cast-tela">ƒå√≠seln√Ω k√≥d a zranƒõn√° ƒç√°st tƒõla (ESAW)</label>
          <select id="c-cast-tela" required></select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-cinnost">ƒåinnost, p≈ôi kter√© k √∫razu do≈°lo</label>
          <input id="c-cinnost" required>
          <div class="error-msg hidden"></div>
        </div>
        <div class="col-6 field">
          <label class="req" for="c-misto">M√≠sto, kde k √∫razu do≈°lo</label>
          <input id="c-misto" required>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-3 field">
          <label class="req" for="c-pracoviste">Bylo m√≠sto √∫razu pravideln√Ωm pracovi≈°tƒõm?</label>
          <select id="c-pracoviste" required>
            <option value="" disabled selected>‚Äî vyberte ‚Äî</option>
            <option>ANO</option>
            <option>NE</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-zdroj">Co bylo zdrojem √∫razu? (m≈Ø≈æete vybrat v√≠ce)</label>
          <select id="c-zdroj" multiple size="8">
            <option>dopravn√≠ prost≈ôedek</option>
            <option>stroje a za≈ô√≠zen√≠ p≈ôenosn√° nebo mobiln√≠</option>
            <option>materi√°l, b≈ôemena, p≈ôedmƒõty (p√°d, p≈ôira≈æen√≠, odl√©tnut√≠, n√°raz, zavalen√≠)</option>
            <option>p√°d na rovinƒõ, z v√Ω≈°ky, do hloubky, propadnut√≠</option>
            <option>n√°stroj, p≈ô√≠stroj, n√°≈ôad√≠</option>
            <option>pr≈Ømyslov√© ≈°kodliviny, chemick√© l√°tky, biologick√© ƒçinitele</option>
            <option>hork√© l√°tky a p≈ôedmƒõty, ohe≈à a v√Ωbu≈°niny</option>
            <option>stroje a stabiln√≠ za≈ô√≠zen√≠</option>
            <option>lid√©, zv√≠≈ôata nebo p≈ô√≠rodn√≠ ≈æivly</option>
            <option>elektrick√° energie</option>
            <option>jin√Ω bl√≠≈æe nespecifikovan√Ω zdroj</option>
          </select>
          <div class="help">Pro v√≠ce polo≈æek dr≈æte <strong>Ctrl</strong> a klikejte my≈°√≠. Pro souvisl√Ω v√Ωbƒõr pou≈æijte <strong>Shift</strong>.</div>
          <div class="error-msg hidden"></div>
          <div id="m-zdroj" class="print-only muted"></div>
        </div>

        <div class="col-6 field">
          <label class="req" for="c-priciny">Proƒç k √∫razu do≈°lo? (p≈ô√≠ƒçiny; v√Ωbƒõr v√≠ce mo≈ænost√≠)</label>
          <select id="c-priciny" multiple size="8">
            <option>pro poruchu nebo vadn√Ω stav nƒõkter√©ho ze zdroj≈Ø √∫razu</option>
            <option>pro ≈°patn√© nebo nedostateƒçn√© vyhodnocen√≠ rizika</option>
            <option>z√°vady na pracovi≈°ti</option>
            <option>pro nedostateƒçn√© osobn√≠ zaji≈°tƒõn√≠ zamƒõstnance vƒçetnƒõ OOPP</option>
            <option>pro poru≈°en√≠ p≈ôedpis≈Ø vztahuj√≠c√≠ch se k pr√°ci nebo pokyn≈Ø zamƒõstnavatele</option>
            <option>pro nep≈ôedv√≠dateln√© riziko pr√°ce nebo selh√°n√≠ lidsk√©ho ƒçinitele</option>
            <option>pro jin√Ω, bl√≠≈æe nespecifikovateln√Ω d≈Øvod</option>
          </select>
          <div class="help">Pro v√≠ce polo≈æek dr≈æte <strong>Ctrl</strong> a klikejte my≈°√≠. Pro souvisl√Ω v√Ωbƒõr pou≈æijte <strong>Shift</strong>.</div>
          <div class="error-msg hidden"></div>
          <div id="m-priciny" class="print-only muted"></div>
        </div>

        <div class="col-12 field">
          <label class="req" for="c-popis">Popis √∫razov√©ho dƒõje</label>
          <textarea id="c-popis" required placeholder="Struƒçnƒõ a vƒõcnƒõ popi≈°te pr≈Øbƒõh ud√°losti‚Ä¶"></textarea>
          <div class="error-msg hidden"></div>
        </div>

        <div class="col-3 field">
          <label class="req" for="c-dech">Byla provedena dechov√° zkou≈°ka na alkohol?</label>
          <select id="c-dech" required>
            <option value="" disabled selected>‚Äî vyberte ‚Äî</option>
            <option>ANO</option>
            <option>NE</option>
          </select>
          <div class="error-msg hidden"></div>
        </div>
      </div>
    </section>

    <!-- D -->
    <section class="card">
      <h2><span class="badge">D</span> Potvrzuj√≠c√≠ √∫daje</h2>
      <p class="muted" style="font-size:16px;line-height:1.6">
        Posti≈æen√Ω sv√Ωm podpisem stvrzuje, ≈æe byl p≈ôed vy≈°et≈ôov√°n√≠m p≈ô√≠ƒçin a okolnost√≠ vzniku pracovn√≠ho √∫razu zamƒõstnavatelem pouƒçen
        o jeho povinnosti vypov√≠dat pravdivƒõ a nic nezamlƒçet a o pr√°vn√≠ch n√°sledc√≠ch nepravdiv√© nebo ne√∫pln√© v√Ωpovƒõdi a rovnƒõ≈æ ƒçestnƒõ
        prohla≈°uje, ≈æe jeho v√Ωpovƒõƒè byla √∫pln√° a pravdiv√°.
      </p>
      <div class="row">
        <div class="col-3 field">
          <label for="d-datum-podpis">Datum a podpis posti≈æen√©ho (podle mo≈ænost√≠)</label>
          <input id="d-datum-podpis" type="date">
          <button class="picker-btn" type="button" onclick="openPicker('d-datum-podpis')" title="Otev≈ô√≠t kalend√°≈ô">üìÖ</button>
        </div>

        <div class="col-12">
          <p class="muted" style="font-size:16px;line-height:1.6"><strong>Svƒõdci ƒçestnƒõ prohla≈°uj√≠</strong> a sv√Ωm n√≠≈æe uveden√Ωm podpisem stvrzuj√≠, ≈æe jejich v√Ωpovƒõƒè byla √∫pln√° a pravdiv√°.</p>
          <div id="svedci-list" class="list"></div>
          <div style="margin-top:8px">
            <button type="button" class="ghost btn-add-svedek" onclick="addSvedek()">‚ûï P≈ôidat svƒõdka</button>
          </div>
        </div>

        <div class="col-12 field">
          <label for="d-zapis">Zapisuj√≠c√≠ zamƒõstnanec (datum, jm√©no a p≈ô√≠jmen√≠, pracovn√≠ za≈ôazen√≠ a podpis)</label>
          <textarea id="d-zapis" placeholder="Nap≈ô.: 2025-10-02 ‚Äì Lubo≈° Jaro≈°, spr√°vce centra informac√≠, podpis‚Ä¶"></textarea>
        </div>
      </div>
    </section>
  </form>
</main>

<script>
"use strict";

/* ===== KONFIG ===== */
const STORAGE_FORM          = 'formular_uraz_v1';
const STORAGE_RECIPIENTS    = 'formular_uraz_email_to_list';
const STORAGE_OWA_ONLY      = 'formular_uraz_use_owa_only';
const LOGO_SRC              = "LECO_nove.jpg";
let   DEF_A = { zam:"", ico:"", sidlo:"" };

/* ===== Pomocn√© ===== */
function openPicker(id){
  const el = document.getElementById(id);
  if(!el) return;
  if(typeof el.showPicker === "function"){ try{ el.showPicker(); return; }catch(e){} }
  el.focus(); try{ el.click(); }catch(_){}
}
function isEmpty(v){ return !v || !String(v).trim(); }
function todayLocalISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function safeFileName(s){return (s||'bez-jmena').replace(/[\\/:*?"<>|]+/g,'').trim().replace(/\s+/g,'_');}

/* ===== Banner validace ===== */
function showValidationBanner(firstErrorEl){
  const banner = document.getElementById('val-banner');
  if (banner) banner.style.display = 'block';
  if (firstErrorEl && typeof firstErrorEl.scrollIntoView === 'function') {
    firstErrorEl.scrollIntoView({behavior:'smooth', block:'center'});
    try { firstErrorEl.focus({preventScroll:true}); } catch(_){}
  }
}

/* ===== ESAW data ===== */
const ESAW_INJURY=[{code:"000",label:"Nezn√°m√Ω nebo neurƒçen√Ω druh zranƒõn√≠"},{code:"010",label:"R√°ny a povrchov√° zranƒõn√≠"},{code:"011",label:"Povrchov√© zranƒõn√≠"},{code:"012",label:"Otev≈ôen√© r√°ny"},{code:"019",label:"Jin√© typy ran a povrchov√Ωch zranƒõn√≠"},{code:"020",label:"Zlomeniny kost√≠"},{code:"021",label:"Zav≈ôen√© zlomeniny"},{code:"022",label:"Otev≈ôen√© zlomeniny"},{code:"029",label:"Jin√© typy zlomenin kost√≠"},{code:"030",label:"Vyklouben√≠, vyvrtnut√≠, nata≈æen√≠"},{code:"031",label:"Vyklouben√≠ nebo ne√∫pln√© vyklouben√≠"},{code:"032",label:"Vyvrtnut√≠ nebo nata≈æen√≠"},{code:"039",label:"Jin√© typy vyklouben√≠, vyvrtnut√≠, nata≈æen√≠"},{code:"040",label:"Traumatick√° amputace (ztr√°ta ƒç√°sti tƒõla)"},{code:"050",label:"Ot≈ôes mozku a vnit≈ôn√≠ zranƒõn√≠"},{code:"051",label:"Ot≈ôes mozku a vnitrolebeƒçn√≠ zranƒõn√≠"},{code:"052",label:"Vnit≈ôn√≠ zranƒõn√≠"},{code:"059",label:"Jin√© typy ot≈ôes≈Ø mozku a vnit≈ôn√≠ch zranƒõn√≠"},{code:"060",label:"Pop√°leniny, opa≈ôeniny a omrzliny"},{code:"061",label:"Pop√°leniny a opa≈ôeniny (tepeln√©)"},{code:"062",label:"Chemick√© pop√°leniny (polept√°n√≠)"},{code:"063",label:"Omrzliny"},{code:"069",label:"Jin√© typy pop√°lenin, opa≈ôenin a omrzlin"},{code:"070",label:"Otravy a infekce"},{code:"071",label:"Akutn√≠ otravy"},{code:"072",label:"Akutn√≠ infekce"},{code:"079",label:"Jin√© typy otrav a infekc√≠"},{code:"080",label:"Tonut√≠ a du≈°en√≠"},{code:"081",label:"Du≈°en√≠"},{code:"082",label:"Tonut√≠ bez smrteln√Ωch n√°sledk≈Ø"},{code:"089",label:"Jin√© typy tonut√≠ a du≈°en√≠"},{code:"090",label:"√öƒçinky zvuku, vibrac√≠ a tlaku"},{code:"091",label:"Akutn√≠ ztr√°ta sluchu"},{code:"092",label:"P≈Øsoben√≠ tlaku (barotrauma)"},{code:"099",label:"Jin√© √∫ƒçinky zvuku, vibrac√≠ a tlaku"},{code:"100",label:"√öƒçinky extr√©mn√≠ch teplot, svƒõtla a oz√°≈ôen√≠"},{code:"101",label:"√ö≈æeh z tepla a sluneƒçn√≠ho z√°≈ôen√≠"},{code:"102",label:"√öƒçinky oz√°≈ôen√≠ (netepeln√©)"},{code:"103",label:"√öƒçinky sn√≠≈æen√© teploty"},{code:"109",label:"Jin√© √∫ƒçinky extr√©mn√≠ch teplot, svƒõtla a oz√°≈ôen√≠"},{code:"110",label:"≈†ok"},{code:"111",label:"≈†oky po agres√≠ch a hrozb√°ch"},{code:"112",label:"Traumatick√© ≈°oky"},{code:"119",label:"Jin√© typy ≈°ok≈Ø"},{code:"120",label:"V√≠cen√°sobn√© zranƒõn√≠"},{code:"999",label:"Jin√° specifick√° zranƒõn√≠ nezahrnut√° do jin√Ωch kategori√≠"}];
const ESAW_BODY=[{code:"00",label:"Zranƒõn√° ƒç√°st tƒõla nespecifikovan√°"},{code:"10",label:"Hlava bez podrobnƒõj≈°√≠ho rozli≈°en√≠, d√°le nespecifikovan√°"},{code:"11",label:"Hlava, mozek, lebeƒçn√≠ nervy a c√©vy"},{code:"12",label:"Tv√°≈ô"},{code:"13",label:"Oko"},{code:"14",label:"Ucho"},{code:"15",label:"Zuby"},{code:"18",label:"Hlava ‚Äì v√≠ce posti≈æen√Ωch oblast√≠"},{code:"19",label:"Hlava ‚Äì jin√© ƒç√°sti v√Ω≈°e neuveden√©"},{code:"20",label:"Krk vƒçetnƒõ p√°te≈ôe a krƒçn√≠ch obratl≈Ø"},{code:"21",label:"Krk vƒçetnƒõ p√°te≈ôe a krƒçn√≠ch obratl≈Ø"},{code:"29",label:"Krk ‚Äì jin√© ƒç√°sti dosud neuveden√©"},{code:"30",label:"Z√°da vƒçetnƒõ p√°te≈ôe a z√°dov√Ωch obratl≈Ø"},{code:"31",label:"Z√°da vƒçetnƒõ p√°te≈ôe a z√°dov√Ωch obratl≈Ø"},{code:"39",label:"Z√°da ‚Äì jin√© ƒç√°sti v√Ω≈°e neuveden√©"},{code:"40",label:"Trup a org√°ny bez podrobnƒõj≈°√≠ho rozli≈°en√≠"},{code:"41",label:"Hrudn√≠ ko≈°, ≈æebra vƒçetnƒõ kloub≈Ø a lopatek"},{code:"42",label:"Oblast hrudn√≠ku vƒçetnƒõ org√°n≈Ø"},{code:"43",label:"P√°nevn√≠ a b≈ôi≈°n√≠ oblast vƒçetnƒõ org√°n≈Ø"},{code:"48",label:"Trup ‚Äì v√≠ce posti≈æen√Ωch oblast√≠"},{code:"49",label:"Trup ‚Äì jin√© ƒç√°sti v√Ω≈°e neuveden√©"},{code:"50",label:"Horn√≠ konƒçetiny bez podrobnƒõj≈°√≠ho rozli≈°en√≠"},{code:"51",label:"Rameno a ramenn√≠ klouby"},{code:"52",label:"Ruka vƒçetnƒõ lokte"},{code:"53",label:"Ruka od z√°pƒõst√≠ dol≈Ø"},{code:"54",label:"Prst"},{code:"55",label:"Z√°pƒõst√≠"},{code:"58",label:"Horn√≠ konƒçetiny ‚Äì v√≠ce posti≈æen√Ωch oblast√≠"},{code:"59",label:"Horn√≠ konƒçetiny ‚Äì jin√© ƒç√°sti v√Ω≈°e neuveden√©"},{code:"60",label:"Doln√≠ konƒçetiny bez podrobnƒõj≈°√≠ho rozli≈°en√≠"},{code:"61",label:"Bedra, bedern√≠ klouby"},{code:"62",label:"Noha vƒçetnƒõ kolena"},{code:"63",label:"Kotn√≠k"},{code:"64",label:"Noha od kotn√≠ku dol≈Ø"},{code:"65",label:"Prst na noze"},{code:"68",label:"Doln√≠ konƒçetiny ‚Äì v√≠ce posti≈æen√Ωch oblast√≠"},{code:"69",label:"Doln√≠ konƒçetiny ‚Äì jin√© ƒç√°sti v√Ω≈°e neuveden√©"},{code:"70",label:"Cel√© tƒõlo a v√≠ce oblast√≠ bez podrobnƒõj≈°√≠ho rozli≈°en√≠"},{code:"71",label:"Cel√© tƒõlo (syst√©mov√© √∫ƒçinky)"},{code:"78",label:"Tƒõlo ‚Äì v√≠ce posti≈æen√Ωch oblast√≠"},{code:"79",label:"Tƒõlo ‚Äì jin√° zranƒõn√° ƒç√°st tƒõla v√Ω≈°e neuveden√°"}];

/* ===== Svƒõdci ===== */
let svedekId=0;
function addSvedek(valueDate="", valueName=""){
  const root=document.getElementById('svedci-list'); if(!root) return;
  const id=++svedekId;
  const row=document.createElement('div'); row.className='list-item'; row.id='svedek-'+id;
  row.style.display="grid"; row.style.gridTemplateColumns="1fr 2fr auto"; row.style.gap="8px"; row.style.margin="6px 0";
  row.innerHTML =
   `<div class="field">
      <label for="sv-${id}-date">Datum</label>
      <input id="sv-${id}-date" type="date" value="${valueDate}">
      <button class="picker-btn" type="button" onclick="openPicker('sv-${id}-date')" title="Otev≈ô√≠t kalend√°≈ô">üìÖ</button>
    </div>
    <div class="field">
      <label for="sv-${id}-name">Jm√©no a p≈ô√≠jmen√≠ svƒõdka</label>
      <input id="sv-${id}-name" value="${valueName}" placeholder="Nap≈ô.: Jan Nov√°k">
    </div>
    <div class="actions" style="display:flex;align-items:end">
      <button type="button" class="ghost btn-del-svedek" onclick="delSvedek(${id})">‚úñÔ∏è</button>
    </div>`;
  root.appendChild(row);
  autosaveDebounced();
}
function delSvedek(id){ const el=document.getElementById('svedek-'+id); if(el) el.remove(); autosaveDebounced(); }

/* ===== Validace ===== */
function clearErrors(){
  document.querySelectorAll('.error').forEach(el=>el.classList.remove('error'));
  document.querySelectorAll('.error-msg').forEach(m=>{m.classList.add('hidden'); m.textContent='';});
}
function showError(el,msg){
  if(!el) return;
  el.classList.add('error');
  const box=el.closest('.field'); const m=box?.querySelector('.error-msg'); if(m){ m.textContent=msg; m.classList.remove('hidden'); }
}
function validateSectionA(){
  let ok=true;
  const aZ=document.getElementById('a-zam'), aI=document.getElementById('a-ico'), aS=document.getElementById('a-sidlo');
  const z2=document.getElementById('a-zam2'), i2=document.getElementById('a-ico2'), s2=document.getElementById('a-sidlo2');
  const anyOther = !isEmpty(z2.value) || !isEmpty(i2.value) || !isEmpty(s2.value);
  if (anyOther){
    if (isEmpty(z2.value)){ showError(z2,'Vypl≈àte n√°zev jin√©ho zamƒõstnavatele.'); ok=false; }
    if (isEmpty(i2.value)){ showError(i2,'Vypl≈àte IƒåO jin√©ho zamƒõstnavatele.'); ok=false; }
    if (isEmpty(s2.value)){ showError(s2,'Vypl≈àte s√≠dlo jin√©ho zamƒõstnavatele.'); ok=false; }
    aZ.value=""; aI.value=""; aS.value="";
  } else {
    if (isEmpty(aZ.value)){ showError(aZ,'Chyb√≠ n√°zev zamƒõstnavatele.'); ok=false; }
    if (isEmpty(aI.value)){ showError(aI,'Chyb√≠ IƒåO zamƒõstnavatele.'); ok=false; }
    if (isEmpty(aS.value)){ showError(aS,'Chyb√≠ s√≠dlo zamƒõstnavatele.'); ok=false; }
  }
  return ok;
}
function validateRequired(){
  clearErrors(); let ok=true; let firstErr=null;

  if (!validateSectionA()) ok=false;

  [['b-jmeno','Vypl≈àte jm√©no a p≈ô√≠jmen√≠.'],
   ['b-datum','Vyberte datum narozen√≠.'],
   ['b-prace','Vypl≈àte druh pr√°ce.'],
   ['b-status','Vyberte status posti≈æen√©ho.']].forEach(([id,msg])=>{
     const el=document.getElementById(id);
     if(!el || !el.value){ showError(el,msg); ok=false; if(!firstErr) firstErr=el; }
  });

  [['c-datum','Zadejte datum a ƒças √∫razu.'],
   ['c-hodiny','Uveƒète poƒçet hodin.'],
   ['c-pocet','Uveƒète poƒçet zranƒõn√Ωch osob.'],
   ['c-druh-urazu','Vyberte druh √∫razu.'],
   ['c-druh-zraneni','Vyberte druh zranƒõn√≠ (ESAW).'],
   ['c-cast-tela','Vyberte zranƒõnou ƒç√°st tƒõla (ESAW).'],
   ['c-cinnost','Vypl≈àte ƒçinnost.'],
   ['c-misto','Vypl≈àte m√≠sto.'],
   ['c-pracoviste','Vyberte ANO/NE.'],
   ['c-popis','Vypl≈àte popis dƒõje.'],
   ['c-dech','Vyberte ANO/NE.']].forEach(([id,msg])=>{
     const el=document.getElementById(id);
     if(!el || !el.value){ showError(el,msg); ok=false; if(!firstErr) firstErr=el; }
  });

  const zdroj=document.getElementById('c-zdroj'), pric=document.getElementById('c-priciny');
  if(!(zdroj?.selectedOptions?.length>0)){ showError(zdroj,'Vyberte alespo≈à jednu mo≈ænost.'); ok=false; if(!firstErr) firstErr=zdroj; }
  if(!(pric?.selectedOptions?.length>0)){ showError(pric,'Vyberte alespo≈à jednu mo≈ænost.'); ok=false; if(!firstErr) firstErr=pric; }

  const banner = document.getElementById('val-banner');
  if (!ok) { showValidationBanner(firstErr); }
  else if (banner) { banner.style.display = 'none'; }

  return ok;
}

/* ===== Sbƒõr dat ===== */
function getVal(id){ const el=document.getElementById(id); return el && 'value' in el ? (el.value||'').trim() : ''; }
function getMulti(id){ const el=document.getElementById(id); return el ? Array.from(el.selectedOptions).map(o=>o.textContent.trim()) : []; }
function byCode(arr, code){ return arr.find(x=>x.code===code)||null; }
function updatePrintMirrors(){
  const zd=document.getElementById('m-zdroj'); if(zd) zd.textContent=getMulti('c-zdroj').join('; ')||'‚Äî';
  const pr=document.getElementById('m-priciny'); if(pr) pr.textContent=getMulti('c-priciny').join('; ')||'‚Äî';
  const e1=getVal('a-zam2'), e2=getVal('a-ico2'), e3=getVal('a-sidlo2');
  const det=document.getElementById('opt-employer'); if(det){ det.classList.toggle('print-hide', !(e1||e2||e3)); }
}
function collectData(){
  const svedci=[]; document.querySelectorAll('#svedci-list .list-item').forEach(row=>{
    const date=row.querySelector('input[type="date"]')?.value||""; const name=row.querySelector('input[type="text"]')?.value||"";
    if(date || name) svedci.push({date,name});
  });
  const d={
    A_Zamestnavatel:getVal('a-zam'), A_Sidlo:getVal('a-sidlo'), A_ICO:getVal('a-ico'),
    A_JinyZam:getVal('a-zam2'), A_JinyICO:getVal('a-ico2'), A_JineSidlo:getVal('a-sidlo2'),
    B_Jmeno:getVal('b-jmeno'), B_DatumNarozeni:getVal('b-datum'), B_DruhPrace:getVal('b-prace'), B_Status:getVal('b-status'),
    C_DatumCas:getVal('c-datum'), C_HodinyPred:getVal('c-hodiny'), C_PocetZr:getVal('c-pocet'), C_DruhUrazu:getVal('c-druh-urazu'),
    C_DruhZraneniKod:getVal('c-druh-zraneni'), C_CastTelaKod:getVal('c-cast-tela'),
    C_Cinnost:getVal('c-cinnost'), C_Misto:getVal('c-misto'), C_PravPracoviste:getVal('c-pracoviste'),
    C_Zdroj:getMulti('c-zdroj'), C_Priciny:getMulti('c-priciny'), C_Popis:getVal('c-popis'), C_Dech:getVal('c-dech'),
    D_DatumPodpisPostizeneho:getVal('d-datum-podpis'), D_Svedci:svedci, D_Zapisujici:getVal('d-zapis')
  };
  const inj=byCode(ESAW_INJURY,d.C_DruhZraneniKod), bod=byCode(ESAW_BODY,d.C_CastTelaKod);
  d.C_DruhZraneniPopis=inj?inj.label:""; d.C_CastTelaPopis=bod?bod.label:"";
  return d;
}

/* ===== Ulo≈æen√≠/Obnova ===== */
function saveToStorage(){try{localStorage.setItem(STORAGE_FORM, JSON.stringify(collectData()));}catch(e){}}
function restoreFromStorage(){
  try{
    const raw=localStorage.getItem(STORAGE_FORM); if(!raw) return;
    const d=JSON.parse(raw);
    document.getElementById('a-zam').value=d.A_Zamestnavatel ?? DEF_A.zam;
    document.getElementById('a-ico').value=d.A_ICO ?? DEF_A.ico;
    document.getElementById('a-sidlo').value=d.A_Sidlo ?? DEF_A.sidlo;
    document.getElementById('a-zam2').value=d.A_JinyZam ?? "";
    document.getElementById('a-ico2').value=d.A_JinyICO ?? "";
    document.getElementById('a-sidlo2').value=d.A_JineSidlo ?? "";
    otherEmployerChanged();

    document.getElementById('b-jmeno').value=d.B_Jmeno ?? "";
    document.getElementById('b-datum').value=d.B_DatumNarozeni ?? "";
    document.getElementById('b-prace').value=d.B_DruhPrace ?? "";
    document.getElementById('b-status').value=d.B_Status ?? "";

    document.getElementById('c-datum').value=d.C_DatumCas ?? "";
    document.getElementById('c-hodiny').value=d.C_HodinyPred ?? "";
    document.getElementById('c-pocet').value=d.C_PocetZr ?? "";
    document.getElementById('c-druh-urazu').value=d.C_DruhUrazu ?? "";
    document.getElementById('c-druh-zraneni').value=d.C_DruhZraneniKod ?? "";
    document.getElementById('c-cast-tela').value=d.C_CastTelaKod ?? "";
    document.getElementById('c-cinnost').value=d.C_Cinnost ?? "";
    document.getElementById('c-misto').value=d.C_Misto ?? "";
    document.getElementById('c-pracoviste').value=d.C_PravPracoviste ?? "";

    const setMultiByText=(id,items)=>{const el=document.getElementById(id);const set=new Set((items||[]).map(s=>String(s).trim()));Array.from(el.options).forEach(o=>o.selected=set.has(o.textContent.trim()));}
    setMultiByText('c-zdroj', d.C_Zdroj ?? []);
    setMultiByText('c-priciny', d.C_Priciny ?? []);

    document.getElementById('c-popis').value=d.C_Popis ?? "";
    document.getElementById('c-dech').value=d.C_Dech ?? "";

    const root=document.getElementById('svedci-list'); root.innerHTML=''; svedekId=0;
    (Array.isArray(d.D_Svedci)&&d.D_Svedci.length? d.D_Svedci : [{date:'',name:''}]).forEach(s=>addSvedek(s.date||'', s.name||''));
    document.getElementById('d-datum-podpis').value=d.D_DatumPodpisPostizeneho ?? "";
    document.getElementById('d-zapis').value=d.D_Zapisujici ?? "";
  }catch(e){}
}
function debounce(fn,t=300){let h;return(...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),t);};}
const autosaveDebounced=debounce(saveToStorage,300);

/* ===== Sekce A ‚Äì defaulty vs. jin√Ω zamƒõstnavatel ===== */
function captureDefaultsA(){
  DEF_A={ zam:document.getElementById('a-zam').value, ico:document.getElementById('a-ico').value, sidlo:document.getElementById('a-sidlo').value };
}
function otherEmployerChanged(){
  const z2=getVal('a-zam2'), i2=getVal('a-ico2'), s2=getVal('a-sidlo2');
  const any=!!(z2||i2||s2);
  const aZ=document.getElementById('a-zam'), aI=document.getElementById('a-ico'), aS=document.getElementById('a-sidlo');
  if(any){ aZ.value=""; aI.value=""; aS.value=""; } else { aZ.value=DEF_A.zam; aI.value=DEF_A.ico; aS.value=DEF_A.sidlo; }
}

/* ===== Logo ‚Üí dataURL ===== */
async function loadLogoDataURL(){
  const img=document.getElementById('brand-logo'); if(!img) return "";
  if(!img.src) img.src=LOGO_SRC;
  if(!img.complete || !img.naturalWidth){ await new Promise(res=>{ img.onload=res; img.onerror=res; }); }
  try{ const cv=document.createElement('canvas'); cv.width=img.naturalWidth; cv.height=img.naturalHeight; cv.getContext('2d').drawImage(img,0,0); return cv.toDataURL('image/png'); }catch(_){ return ""; }
}
function dataURLParts(durl){ const m=/^data:([^;]+);base64,(.*)$/i.exec(durl||""); return m?{mime:m[1],base64:m[2]}:null; }

/* ===== Word (.doc MHTML) ===== */
function buildReadablePairs(d){
  const R=[]; const H=t=>R.push([t,""]); const P=(k,v)=>R.push([k,v||""]);
  H("A) √ödaje o zamƒõstnavateli"); P("N√°zev zamƒõstnavatele",d.A_Zamestnavatel); P("S√≠dlo (adresa)",d.A_Sidlo); P("IƒåO",d.A_ICO);
  if(d.A_JinyZam||d.A_JinyICO||d.A_JineSidlo){ P("Jin√Ω zamƒõstnavatel",d.A_JinyZam); P("IƒåO (jin√Ω)",d.A_JinyICO); P("S√≠dlo (jin√Ω)",d.A_JineSidlo); }
  H("B) √ödaje o posti≈æen√©m"); P("Jm√©no a p≈ô√≠jmen√≠",d.B_Jmeno); P("Datum narozen√≠",d.B_DatumNarozeni); P("Druh pr√°ce",d.B_DruhPrace); P("Posti≈æen√Ω je",d.B_Status);
  H("C) √ödaje o √∫razu"); P("Datum a ƒças √∫razu",d.C_DatumCas); P("Hodiny p≈ôed √∫razem",d.C_HodinyPred); P("Poƒçet zranƒõn√Ωch osob",d.C_PocetZr); P("Druh √∫razu",d.C_DruhUrazu);
  P("Druh zranƒõn√≠ (k√≥d ‚Äì popis)", d.C_DruhZraneniKod? `${d.C_DruhZraneniKod} ‚Äî ${d.C_DruhZraneniPopis}`:"");
  P("Zranƒõn√° ƒç√°st tƒõla (k√≥d ‚Äì popis)", d.C_CastTelaKod? `${d.C_CastTelaKod} ‚Äî ${d.C_CastTelaPopis}`:"");
  P("ƒåinnost",d.C_Cinnost); P("M√≠sto √∫razu",d.C_Misto); P("Pravideln√© pracovi≈°tƒõ",d.C_PravPracoviste);
  P("Zdroj √∫razu (v√≠ce)",d.C_Zdroj.join("; ")); P("P≈ô√≠ƒçiny (v√≠ce)",d.C_Priciny.join("; ")); P("Popis dƒõje",d.C_Popis); P("Dechov√° zkou≈°ka",d.C_Dech);
  H("D) Potvrzuj√≠c√≠ √∫daje"); P("Datum/podpis posti≈æen√©ho",d.D_DatumPodpisPostizeneho);
  (d.D_Svedci||[]).forEach((s,i)=>P(`Svƒõdek ${i+1}`,(s.date? s.date+" ‚Äì ":"")+(s.name||""))); P("Zapisuj√≠c√≠ zamƒõstnanec",d.D_Zapisujici);
  return R;
}
function buildMhtmlHtmlBody(rows, hasLogo){
  return `
  <html><head><meta charset="utf-8">
    <style>
      @page Section1 { size:595.3pt 841.9pt; margin:28.35pt; }
      div.Section1 { page:Section1; }
      body{font-family:Segoe UI,Arial,sans-serif;color:#111}
      h1{font-size:18pt;margin:0 0 10pt 0}
      .logo{margin:0 0 8pt 0}
      table{border-collapse:collapse;width:100%}
      td{border:1px solid #ddd;padding:6pt;vertical-align:top}
      td.k{width:34%;background:#f3f4f6;font-weight:700}
      .sec{background:#e5e7eb;font-weight:700;text-transform:uppercase}
    </style>
  </head>
  <body><div class="Section1">
    ${hasLogo ? `<div class="logo">cid:logo1</div>` : ``}
    <h1>Z√°znam o pracovn√≠m √∫razu</h1>
    <table>
      ${rows.map(([k,v])=> v==="" ? `<tr><td class="sec" colspan="2">${k}</td></tr>` : `<tr><td class="k">${k}</td><td>${String(v||"").replace(/</g,"&lt;")}</td></tr>`).join("")}
    </table>
  </div></body></html>`;
}
async function buildDocMhtmlBlob(){
  const d = collectData(); const rows = buildReadablePairs(d);
  const composeDate=todayLocalISO(); const victimName=safeFileName(d.B_Jmeno); const fileName=`${victimName} - ${composeDate}.doc`;
  const logoDataURL=await loadLogoDataURL(); const hasLogo=!!logoDataURL; const htmlBody=buildMhtmlHtmlBody(rows, hasLogo);
  const boundary="----=_NextPart_"+Date.now();
  let mhtml=""; mhtml+="MIME-Version: 1.0\r\n"; mhtml+=`Content-Type: multipart/related; type="text/html"; boundary="${boundary}"\r\n\r\n`;
  mhtml+=`--${boundary}\r\nContent-Type: text/html; charset="utf-8"\r\nContent-Transfer-Encoding: 8bit\r\n\r\n${htmlBody}\r\n\r\n`;
  if(hasLogo){ const p=dataURLParts(logoDataURL); const base64=(p.base64.match(/.{1,76}/g)||[p.base64]).join("\r\n");
    mhtml+=`--${boundary}\r\nContent-Type: ${p.mime}\r\nContent-Transfer-Encoding: base64\r\nContent-Location: logo1\r\nContent-ID: <logo1>\r\n\r\n${base64}\r\n\r\n`;
  }
  mhtml+=`--${boundary}--`;
  const blob=new Blob([mhtml],{type:"application/msword;charset=utf-8"});
  return { blob, fileName };
}

/* ===== P≈ô√≠jemci, OWA-only & nastaven√≠ ===== */
function getRecipients(){
  try{const raw=localStorage.getItem(STORAGE_RECIPIENTS);const arr=raw?JSON.parse(raw):null;if(Array.isArray(arr)&&arr.length>0) return arr;}catch(_){}
  return ['jana.charvatova@le-co.cz'];
}
function setRecipients(list){ localStorage.setItem(STORAGE_RECIPIENTS, JSON.stringify(list)); }
function getOwaOnly(){ try{ return localStorage.getItem(STORAGE_OWA_ONLY)==="1"; }catch(_){ return false; } }
function setOwaOnly(flag){ try{ localStorage.setItem(STORAGE_OWA_ONLY, flag ? "1" : "0"); }catch(_){ } }

function renderRecipientsChips(container,list){
  container.innerHTML=""; list.forEach((email,idx)=>{ const chip=document.createElement('span');
    chip.style.cssText="display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:13px";
    chip.textContent=email+" "; const btn=document.createElement('button'); btn.type="button"; btn.textContent="‚úñ"; btn.title="Odebrat";
    btn.style.cssText="margin-left:6px;border:0;background:transparent;cursor:pointer;color:#111";
    btn.onclick=()=>{list.splice(idx,1);renderRecipientsChips(container,list);};
    chip.appendChild(btn); container.appendChild(chip);
  });
}
function openSettings(){
  const pass=prompt("Zadejte heslo pro nastaven√≠ (4 ƒç√≠sla):"); if(pass!=="1991"){ alert("Nespr√°vn√© heslo."); return; }
  const dlg=document.getElementById('dlg-settings'); const list=getRecipients().slice();
  dlg.dataset.work=JSON.stringify(list); renderRecipientsChips(document.getElementById('recipients-list'), list);
  document.getElementById('inp-email-add').value="";
  document.getElementById('inp-owa-only').checked = getOwaOnly();
  dlg.showModal();
}
function addRecipientFromInput(){
  const dlg=document.getElementById('dlg-settings'); const list=JSON.parse(dlg.dataset.work||"[]");
  const inp=document.getElementById('inp-email-add'); const v=(inp.value||"").trim(); const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!re.test(v)){ alert("Zadejte platn√Ω e‚Äëmail."); return; } if(!list.includes(v)) list.push(v); dlg.dataset.work=JSON.stringify(list);
  renderRecipientsChips(document.getElementById('recipients-list'), list); inp.value="";
}
function saveSettings(){
  const dlg=document.getElementById('dlg-settings');
  const list=JSON.parse(dlg.dataset.work||"[]").filter(Boolean);
  if(!list.length){ alert("Mus√≠ b√Ωt alespo≈à jeden p≈ô√≠jemce."); return; }
  setRecipients(list);
  setOwaOnly(document.getElementById('inp-owa-only').checked);
  dlg.close();
  alert("Nastaven√≠ ulo≈æeno.\nP≈ô√≠jemci: " + list.join(", ") + "\nV≈ædy pou≈æ√≠t OWA: " + (getOwaOnly() ? "ANO" : "NE"));
}

/* ===== Akce tlaƒç√≠tek ===== */
async function onSaveDocWord(){
  if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; }
  const { blob, fileName } = await buildDocMhtmlBlob();
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);
}
function openOwaComposeWithRecipientsAndSubject(subject){
  const recipients=getRecipients();
  const url=`https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(recipients.join(','))}&subject=${encodeURIComponent(subject)}`;
  window.open(url,"_blank","noopener");
}
async function onSendMail(){
  if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; }
  const { blob, fileName } = await buildDocMhtmlBlob();
  const file = new File([blob], fileName, { type: "application/msword" });
  const subject = buildEmailSubject();

  // Volba "V≈ædy pou≈æ√≠t OWA"
  if (getOwaOnly()){
    try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);}catch(_){}
    openOwaComposeWithRecipientsAndSubject(subject);
    return;
  }

  // Web Share API (HTTPS; dostupnost c√≠le z√°vis√≠ na OS). P≈ôid√°me i url, co≈æ Windows nƒõkdy vy≈æaduje.
  if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
    try{
      await navigator.share({ files:[file], title:"Z√°znam o pracovn√≠m √∫razu", url: location.href });
      return;
    }catch(e){ console.warn("Share zru≈°eno/selhalo:", e); /* pokraƒçuj fallbackem */ }
  }

  // Fallback: st√°hnout soubor + otev≈ô√≠t OWA s p≈ô√≠jemci/p≈ôedmƒõtem
  try{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); URL.revokeObjectURL(a.href);}catch(_){}
  alert("Sd√≠len√≠ do Outlooku nen√≠ dostupn√©. Soubor byl ulo≈æen ‚Äì otev≈ôu Outlook na webu s p≈ô√≠jemci a p≈ôedmƒõtem (p≈ô√≠lohu p≈ôet√°hnƒõte do okna zpr√°vy).");
  openOwaComposeWithRecipientsAndSubject(subject);
}

function onPrint(){ if(!validateRequired()){ window.scrollTo({top:0,behavior:'smooth'}); return; } updatePrintMirrors(); window.print(); }
function onClear(){
  const ok=confirm("Opravdu chcete smazat cel√Ω formul√°≈ô vƒçetnƒõ ulo≈æen√Ωch dat?\nTuto akci nelze vr√°tit zpƒõt."); if(!ok) return;
  const form=document.getElementById('form-uraz'); form.reset(); localStorage.removeItem(STORAGE_FORM);
  otherEmployerChanged(); const root=document.getElementById('svedci-list'); root.innerHTML=''; svedekId=0; addSvedek(); clearErrors();
}

/* ===== P≈ôedmƒõt zpr√°vy ===== */
function buildEmailSubject(){ const d=collectData(); const nm=d.B_Jmeno||"neuvedeno"; const dt=todayLocalISO(); return `Kniha √∫raz≈Ø / ${nm}, ${dt}`; }

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const img=document.getElementById('brand-logo'); if(img) img.src=LOGO_SRC;
  captureDefaultsA();

  // Naplnƒõn√≠ ESAW
  const fill=(selId,arr)=>{ const sel=document.getElementById(selId); if(!sel) return;
    sel.innerHTML='<option value="" disabled selected>‚Äî vyberte ‚Äî</option>';
    arr.forEach(x=>{ const o=document.createElement('option'); o.value=x.code; o.textContent=`${x.code} ‚Äî ${x.label}`; sel.appendChild(o); });
  };
  fill('c-druh-zraneni', ESAW_INJURY); fill('c-cast-tela',  ESAW_BODY);

  // Autosave
  const form=document.getElementById('form-uraz');
  form.addEventListener('input', autosaveDebounced);
  form.addEventListener('change', autosaveDebounced);

  // Jin√Ω zamƒõstnavatel ‚Äì p≈ôep√≠n√°n√≠
  ['a-zam2','a-ico2','a-sidlo2'].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('input', ()=>{ otherEmployerChanged(); autosaveDebounced(); });
    el.addEventListener('change', ()=>{ otherEmployerChanged(); autosaveDebounced(); });
  });

  // Svƒõdek ‚Äì pr√°zdn√° ≈ô√°dka
  if(!document.getElementById('svedci-list').children.length){ addSvedek(); }

  // Obnova dat
  restoreFromStorage();
});

/* ===== Tisk ‚Äì zrcadlen√≠ multi-select ===== */
function onBeforePrint(){ updatePrintMirrors(); }
if(window.matchMedia){
  const mql=window.matchMedia('print');
  (mql.addEventListener ? mql.addEventListener('change',e=>{ if(e.matches) onBeforePrint(); })
                        : mql.addListener(e=>{ if(e.matches) onBeforePrint(); }));
}
window.onbeforeprint=onBeforePrint;

/* ===== P≈ôipnut√≠ funkc√≠ na window (pro jistotu) ===== */
window.onPrint = onPrint;
window.onSaveDocWord = onSaveDocWord;
window.onSendMail = onSendMail;
window.onClear = onClear;
window.openSettings = openSettings;
window.addRecipientFromInput = addRecipientFromInput;
window.saveSettings = saveSettings;
window.openPicker = openPicker;
</script>
</body>
</html>